<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="تطبيق محادثة فوري للتواصل مع الأصدقاء">
<meta name="keywords" content="محادثة, دردشة, تواصل اجتماعي, شات">
<meta name="author" content="تطبيق المحادثة">

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#7C4DFF" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#7C4DFF" media="(prefers-color-scheme: dark)">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="تطبيق المحادثة">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="تطبيق المحادثة">

<!-- Microsoft Meta Tags -->
<meta name="msapplication-TileColor" content="#7C4DFF">
<meta name="msapplication-TileImage" content="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<meta name="msapplication-config" content="none">
<meta name="msapplication-navbutton-color" content="#7C4DFF">

<!-- Social Media Meta Tags -->
<meta property="og:type" content="website">
<meta property="og:title" content="تطبيق المحادثة">
<meta property="og:description" content="تطبيق محادثة فوري للتواصل مع الأصدقاء">
<meta property="og:image" content="https://alqasimmall.github.io/Chat.com/icons/icon-512x512.png">
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
<meta property="og:url" content="https://alqasimmall.github.io/Chat.com/">
<meta property="og:site_name" content="تطبيق المحادثة">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="تطبيق المحادثة">
<meta name="twitter:description" content="تطبيق محادثة فوري للتواصل مع الأصدقاء">
<meta name="twitter:image" content="https://alqasimmall.github.io/Chat.com/icons/icon-512x512.png">
<meta name="twitter:creator" content="@تطبيق_المحادثة">

<title>تطبيق المحادثة</title>

<!-- PWA Links -->
<link rel="manifest" href="./manifest.json" crossorigin="use-credentials">

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="apple-touch-icon" sizes="152x152" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="apple-touch-icon" sizes="167x167" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="apple-touch-icon" sizes="180x180" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">

<!-- Apple Splash Screens -->
<link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="./splash/iPhone_14_Pro_Max_landscape.png">
<link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="./splash/iPhone_14_Pro_landscape.png">
<link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="./splash/iPhone_14_Plus__iPhone_13_Pro_Max__iPhone_12_Pro_Max_landscape.png">
<link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="./splash/iPhone_14__iPhone_13_Pro__iPhone_13__iPhone_12_Pro__iPhone_12_landscape.png">
<link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="./splash/iPhone_13_mini__iPhone_12_mini__iPhone_11_Pro__iPhone_XS__iPhone_X_landscape.png">

<!-- Favicons -->
<link rel="icon" type="image/png" sizes="512x512" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="icon" type="image/png" sizes="384x384" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="icon" type="image/png" sizes="192x192" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="icon" type="image/png" sizes="152x152" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="icon" type="image/png" sizes="144x144" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="icon" type="image/png" sizes="128x128" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="icon" type="image/png" sizes="96x96" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="icon" type="image/png" sizes="72x72" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="icon" type="image/png" sizes="32x32" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="icon" type="image/png" sizes="16x16" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/profiles%2F%D8%AE%D9%84%D9%81%D9%8A%D8%A7%D8%AA%20%D8%A7%D9%8A%D9%81%D9%88%D9%86%2014%20%D8%A8%D8%B1%D9%88%20%D9%85%D8%A7%D9%83%D8%B3%20%D8%A7%D8%B5%D9%84%D9%8A%D8%A9%20%D9%81%D8%AE%D9%85%D9%87%20%D8%A8%D8%AF%D9%82%D8%A9%20HD_1.jpg?alt=media&token=fa611f61-008d-4976-a6cf-f32833ae297c">
<link rel="mask-icon" href="./icons/safari-pinned-tab.svg" color="#7C4DFF">
<link rel="shortcut icon" href="./icons/favicon.ico">

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<!-- CSS Libraries -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

<!-- JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<!-- WebRTC adapter -->
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <style>
/* تنسيقات عامة */
:root {
    --primary-color: #7C4DFF;
    --secondary-color: #5C6BC0;
    --accent-color: #4A90E2;
    --dark-color: #2C3E50;
    --light-color: #f8f9fa;
}

body {
    font-family: 'Cairo', sans-serif;
    background: url('/api/placeholder/1920/1080') center/cover no-repeat fixed;
    height: 100vh;
    margin: 0;
    padding: 0;
    display: flex;
    overflow: hidden;
}

/* تنسيقات الحاويات الرئيسية */
.container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
    display: flex;
    flex-direction: column;
}

.auth-container,
.users-container,
.chat-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
    background: white;
}

/* تنسيقات المحادثة */
.chat-container {
    display: none;
    flex-direction: column;
    background: #efeae2;
}

.chat-header {
    position: sticky;
    top: 0;
    z-index: 4;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 0;
}

.header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    height: 70px;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* تنسيقات منطقة الرسائل */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    position: relative;
    height: calc(100vh - 140px);
}

/* تنسيقات منطقة الإدخال */
.chat-input {
    position: sticky;
    bottom: 0;
    background: #F0F2F5;
    padding: 8px;
    z-index: 4;
    border-top: 1px solid rgba(0,0,0,0.1);
}

.input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    background: white;
    padding: 6px 12px;
    border-radius: 24px;
    margin: 0 auto;
    max-width: 95%;
}

.message-input-container {
    flex: 1;
    min-width: 0;
    position: relative;
}

.message-input {
    width: 100%;
    border: none;
    outline: none;
    padding: 8px 0;
    font-size: 15px;
    background: transparent;
}

/* تنسيقات أزرار المرفقات */
.attachment-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
}

.attachment-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.attachment-btn:hover {
    background-color: rgba(124, 77, 255, 0.1);
}

/* تنسيقات منطقة معاينة الملفات */
.preview-area {
    position: absolute;
    bottom: 100%;
    left: 0;
    right: 0;
    background: white;
    padding: 8px;
    border-radius: 12px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    margin-bottom: 8px;
}

.selected-files-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

/* تنسيقات أزرار الاتصال */
.call-button {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
}

.voice-call {
    background: linear-gradient(135deg, #4CAF50, #45a049);
}

.video-call {
    background: linear-gradient(135deg, #2196F3, #1976D2);
}

/* تنسيقات واجهة الاتصال */
/* تنسيقات واجهة الاتصال المحدثة */
.call-interface {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #000;
    z-index: 1000;
    display: none;
}

.call-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* تنسيق صورة المستخدم */
.caller-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-size: cover;
    background-position: center;
    filter: brightness(0.7);
}

/* معلومات المتصل */
.call-info {
    position: absolute;
    top: 20%;
    left: 0;
    right: 0;
    text-align: center;
    color: white;
    z-index: 2;
}

.caller-name {
    font-size: 24px;
    margin-bottom: 8px;
}

.call-status {
    font-size: 16px;
    opacity: 0.8;
}

/* تنسيق أزرار التحكم */
.call-controls {
    position: absolute;
    bottom: 40px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    gap: 20px;
    padding: 20px;
    z-index: 2;
}

.control-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    backdrop-filter: blur(5px);
    transition: all 0.3s ease;
}

.control-button:hover {
    transform: scale(1.1);
    background: rgba(255, 255, 255, 0.3);
}

.end-call {
    background: rgba(255, 68, 68, 0.8);
}

.end-call:hover {
    background: rgba(255, 68, 68, 1);
}

/* تنسيق فيديو المكالمة */
.video-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
}

.remote-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.local-video {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 120px;
    height: 160px;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

/* تأثيرات إضافية */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.calling .caller-background {
    animation: pulse 2s infinite;
}

.control-button {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.end-call {
    background: #ff4444;
}

/* تنسيقات الفيديو */
.remote-video,
.local-video {
    position: relative;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
}

.remote-video {
    width: 100%;
    max-width: 800px;
    height: 450px;
    margin-top: 20px;
}

.local-video {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 200px;
    height: 150px;
}

/* تحسينات للأجهزة المحمولة */
@media (max-width: 768px) {
    .header-container {
        padding: 0.5rem;
        height: 60px;
    }

    .input-wrapper {
        padding: 4px 10px;
    }

    .call-button {
        width: 36px;
        height: 36px;
    }

    .remote-video {
        height: 300px;
    }

    .local-video {
        width: 120px;
        height: 90px;
    }
}

/* تنسيقات الرسائل */
.message {
    max-width: 75%;
    margin: 2px 15px;
    padding: 8px 12px;
    border-radius: 7.5px;
    position: relative;
    word-wrap: break-word;
}

.message-sent {
    background: #e7ffdb;
    color: #303030;
    margin-left: auto;
    border-top-right-radius: 7.5px;
    border-bottom-right-radius: 0;
}

.message-received {
    background: white;
    color: #303030;
    margin-right: auto;
    border-top-left-radius: 7.5px;
    border-bottom-left-radius: 0;
}

.message-time {
    font-size: 11px;
    color: #667781;
    float: right;
    margin-top: 2px;
}

/* تنسيقات المرفقات */
.message-attachment {
    margin-top: 5px;
    border-radius: 6px;
    overflow: hidden;
}

.message-image {
    max-width: 300px;
    max-height: 300px;
    border-radius: 6px;
    object-fit: cover;
}

.message-audio-wrapper {
    background: transparent;
    padding: 5px;
    border-radius: 6px;
    margin-top: 5px;
}

.message-file-wrapper {
    background: rgba(0,0,0,0.05);
    padding: 10px;
    border-radius: 6px;
    margin-top: 5px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* تنسيقات القوائم المنسدلة */
.menu-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    display: none;
    z-index: 1000;
}

.menu-item {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    color: var(--dark-color);
    text-decoration: none;
    transition: background-color 0.2s ease;
}

.menu-item:hover {
    background-color: rgba(124, 77, 255, 0.1);
}
        .chat-input .form-control {
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            background: white;
        }

        .chat-input .btn {
            border-radius: 50%;
            width: 45px;
            height: 45px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* Animations */
        .fade-enter {
            opacity: 0;
        }

        .fade-enter-active {
            opacity: 1;
            transition: opacity 300ms ease-in;
        }

        .fade-exit {
            opacity: 1;
        }

        .fade-exit-active {
            opacity: 0;
            transition: opacity 300ms ease-in;
        }

        .registration-form {
            display: none;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .social-auth {
            margin-top: 2rem;
            text-align: center;
        }

        .social-auth-divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
        }

        .social-auth-divider::before,
        .social-auth-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e0e0e0;
        }

        .social-auth-divider span {
            padding: 0 1rem;
            color: #666;
            font-size: 0.9rem;
        }

        .social-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .social-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .social-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .social-button.facebook {
            background: #1877f2;
            color: white;
        }

        .social-button.google {
            background: #ea4335;
            color: white;
        }

        .social-button.twitter {
            background: #1da1f2;
            color: white;
        }

        .back-button {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1.25rem;
    width: 100%;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
}

.user-info-section {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.user-details {
    display: flex;
    flex-direction: column;
}

.user-name {
    color: white;
    margin: 0;
    font-size: 1.1rem;
}

.user-id {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.85rem;
}

.header-actions {
    position: relative;
}

.menu-trigger {
    background: transparent;
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.menu-trigger:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.menu-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    width: 280px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    margin-top: 0.5rem;
    display: none;
    z-index: 1000;
    animation: slideDown 0.2s ease;
}

.menu-header {
    padding: 1rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.menu-user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.menu-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.menu-user-details {
    display: flex;
    flex-direction: column;
}

.menu-username {
    font-weight: 600;
    color: var(--dark-color);
}

.menu-email {
    color: #666;
    font-size: 0.85rem;
}

.menu-items {
    padding: 0.5rem 0;
}

.menu-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    color: var(--dark-color);
    text-decoration: none;
    transition: background-color 0.2s ease;
    gap: 1rem;
    cursor: pointer;
}

.menu-item:hover {
    background-color: rgba(124, 77, 255, 0.1);
    color: var(--primary-color);
}

.menu-item i {
    width: 20px;
    text-align: center;
}

.menu-divider {
    height: 1px;
    background: rgba(0,0,0,0.1);
    margin: 0.5rem 0;
}

.menu-badge {
    background: #ff4444;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    margin-right: auto;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* تحسينات إضافية للتجاوب */
@media (max-width: 480px) {
    .menu-dropdown {
        width: calc(100vw - 2rem);
        right: -1rem;
    }
    
    .user-name {
        font-size: 1rem;
    }
    
    .user-id {
        font-size: 0.8rem;
    }
}
.chat-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background-color: #f8f9fa;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

.chat-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 0;
    flex-shrink: 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 100;
}

.header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    height: 70px;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.back-button {
    background: transparent;
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.back-button:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.user-info-section {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.user-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.user-details {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.user-name {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
}

.user-id {
    font-size: 0.8rem;
    opacity: 0.8;
}

.chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem;
    background-color: #f8f9fa;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.chat-input {
    background: white;
    padding: 0.5rem;  /* تقليل الـ padding */
    border-top: 1px solid rgba(0,0,0,0.1);
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10;
}

.input-wrapper {
    display: flex;
    gap: 0.5rem;
    background: #f8f9fa;
    padding: 0.75rem;  /* تقليل الـ padding */
    border-radius: 20px;
    border: 1px solid rgba(0,0,0,0.1);
    margin: 0 auto;
    max-width: 98%;
}

.message-input-container {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}



/* تنسيق الرسائل */
.message {
    max-width: 75%;
    padding: 0.75rem 1rem;
    border-radius: 16px;
    position: relative;
    word-wrap: break-word;
}

.message-sent {
    background: var(--primary-color);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
}

.message-received {
    background: white;
    color: var(--dark-color);
    margin-right: auto;
    border-bottom-left-radius: 4px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 0.25rem;
    text-align: right;
}

/* القائمة المنسدلة */
.header-actions {
    position: relative;
}

.menu-trigger {
    background: transparent;
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.menu-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    width: 280px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    margin-top: 0.5rem;
    display: none;
    z-index: 1000;
    animation: slideDown 0.2s ease;
}

/* التجاوب مع الشاشات المختلفة */
@media (max-width: 768px) {
    .header-container {
        padding: 0.5rem;
    }

    .user-name {
        font-size: 0.9rem;
    }

    .user-id {
        font-size: 0.75rem;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
    }

    .message {
        max-width: 85%;
    }

    .menu-dropdown {
        width: calc(100vw - 2rem);
        right: -1rem;
    }
}

@media (max-width: 480px) {
    .header-container {
        padding: 0.5rem;
        height: 60px;
    }

    .user-avatar {
        width: 35px;
        height: 35px;
    }

    .chat-messages {
        padding: 0.75rem;
    }

    .message {
        max-width: 90%;
        padding: 0.5rem 0.75rem;
    }

    .input-wrapper {
        padding: 0.25rem;
    }

    .message-input {
        padding: 0.5rem;
    }

    .send-button {
        width: 35px;
        height: 35px;
    }
}

/* تنسيقات القائمة المنسدلة */
.menu-header {
    padding: 1rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.menu-user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.menu-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.menu-user-details {
    display: flex;
    flex-direction: column;
}

.menu-username {
    font-weight: 600;
    color: var(--dark-color);
}

.menu-email {
    color: #666;
    font-size: 0.85rem;
}

.menu-items {
    padding: 0.5rem 0;
}

.menu-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    color: var(--dark-color);
    text-decoration: none;
    transition: background-color 0.2s ease;
    gap: 1rem;
    cursor: pointer;
}

.menu-item:hover {
    background-color: rgba(124, 77, 255, 0.1);
    color: var(--primary-color);
}

.menu-divider {
    height: 1px;
    background: rgba(0,0,0,0.1);
    margin: 0.5rem 0;
}

.menu-badge {
    background: #ff4444;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    margin-right: auto;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
/* تحديث الأنماط الأساسية */
.input-wrapper {
    display: flex;
    gap: 0.3rem; /* تقليل المسافة بين العناصر */
    background: #f8f9fa;
    padding: 0.5rem 0.75rem; /* تقليل padding */
    border-radius: 25px; /* تقليل نصف قطر الحواف */
    border: 1px solid rgba(0,0,0,0.1);
    margin: 0 auto;
    max-width: 95%; /* تقليل العرض الأقصى */
    align-items: center;
    min-height: 40px; /* تحديد ارتفاع أدنى */
}

.attachment-buttons {
    display: flex;
    gap: 0.3rem; /* تقليل المسافة بين الأزرار */
}

.attachment-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    width: 28px; /* تقليل حجم الأزرار */
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
    font-size: 0.9rem; /* تقليل حجم الأيقونات */
}

.attachment-btn:hover {
    background: rgba(124, 77, 255, 0.1);
}

/* تحديث أنماط الملفات والمرفقات */
.message-attachment {
    margin-top: 0.3rem;
    border-radius: 6px;
    overflow: hidden;
}

.message-image {
    max-width: 160px; /* تقليل حجم الصور */
    border-radius: 6px;
    height: auto;
}

.message-audio {
    width: 100%;
    max-width: 200px; /* تقليل عرض مشغل الصوت */
    height: 32px; /* تقليل ارتفاع مشغل الصوت */
}

.message-file {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.4rem;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 6px;
    max-width: 180px; /* تحديد عرض أقصى لعرض الملفات */
}

.file-icon {
    font-size: 1.2rem; /* تقليل حجم أيقونة الملف */
}

.file-info {
    display: flex;
    flex-direction: column;
    font-size: 0.8rem;
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px; /* تحديد عرض أقصى لاسم الملف */
}

.file-size {
    color: #666;
    font-size: 0.7rem;
}

/* تحسينات للشاشات الصغيرة */
@media (max-width: 480px) {
    .input-wrapper {
        padding: 0.4rem 0.6rem;
        gap: 0.2rem;
        min-height: 36px;
    }

    .attachment-btn {
        width: 24px;
        height: 24px;
        font-size: 0.8rem;
    }

    .message-image {
        max-width: 140px;
    }

    .message-audio {
        max-width: 180px;
        height: 28px;
    }

    .message-file {
        padding: 0.3rem;
        max-width: 160px;
    }

    .file-icon {
        font-size: 1rem;
    }

    .file-name {
        max-width: 100px;
    }
}

/* تحسينات للشاشات المتوسطة */
@media (min-width: 481px) and (max-width: 768px) {
    .input-wrapper {
        padding: 0.45rem 0.7rem;
        gap: 0.25rem;
        min-height: 38px;
    }

    .attachment-btn {
        width: 26px;
        height: 26px;
        font-size: 0.85rem;
    }

    .message-image {
        max-width: 150px;
    }

    .message-audio {
        max-width: 190px;
        height: 30px;
    }
}

/* تحسينات للشاشات الكبيرة */
@media (min-width: 769px) {
    .input-wrapper {
        max-width: 90%;
    }
}

/* تحسينات إضافية للتجربة */
.message-input {
    flex: 1;
    min-width: 0;
    font-size: 0.9rem;
    padding: 0.3rem 0.5rem;
    border: none;
    background: transparent;
    outline: none;
}

.send-button {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

@media (max-width: 480px) {
    .send-button {
        width: 24px;
        height: 24px;
        font-size: 0.8rem;
    }
}
.preview-area {
    position: absolute;
    bottom: 100%;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.98);
    padding: 8px;
    border-top: 1px solid rgba(0,0,0,0.1);
    max-height: 150px;
    overflow-y: auto;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.selected-files-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 4px;
}

.selected-file-preview {
    position: relative;
    width: 70px;
    height: 70px;
    border-radius: 12px;
    overflow: hidden;
    background: #f5f5f5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* تنسيق overlay التحميل */
.upload-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.spinner-wrapper {
    width: 32px;
    height: 32px;
    position: relative;
    margin-bottom: 8px;
}

.upload-spinner {
    width: 100%;
    height: 100%;
    border: 3px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.upload-success {
    display: none;
    color: #4CAF50;
    font-size: 24px;
    animation: scaleIn 0.3s ease;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes scaleIn {
    from { transform: scale(0); }
    to { transform: scale(1); }
}

.upload-progress {
    font-size: 12px;
    color: white;
    margin-top: 4px;
}

/* تنسيق أنواع الملفات المختلفة */
.selected-file-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.file-preview,
.audio-preview {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 8px;
}

.file-preview i,
.audio-preview i {
    font-size: 24px;
    color: var(--primary-color);
    margin-bottom: 4px;
}

.file-name {
    font-size: 10px;
    color: #666;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    padding: 0 4px;
}

.remove-preview {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    z-index: 2;
    transition: background-color 0.2s ease;
}

.remove-preview:hover {
    background: rgba(0,0,0,0.7);
}

/* تنسيق علامة النجاح */
.success-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 24px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.upload-complete .success-icon {
    opacity: 1;
}

.upload-complete .upload-spinner {
    opacity: 0;
}
/* تنسيقات رسائل الملفات في المحادثة */
.message-attachment {
    max-width: 200px;
    margin-top: 4px;
    position: relative;
}

.message-image {
    max-width: 200px;
    max-height: 200px;
    border-radius: 8px;
    object-fit: cover;
}

.message-file,
.message-audio {
    background: rgba(0,0,0,0.05);
    padding: 8px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-size {
    font-size: 12px;
    color: #666;
}

.attachment-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
}

.attachment-loading .spinner {
    width: 24px;
    height: 24px;
    border: 2px solid #fff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
}



/* إضافة الأنماط CSS الجديدة */
.input-wrapper {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 20px;
    align-items: center;
}

.selected-file-preview {
    position: relative;
    margin: 0.25rem;
}

.preview-inner {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    background: rgba(0,0,0,0.05);
}

.selected-file-preview img {
    max-height: 100px;
    max-width: 100px;
    object-fit: cover;
    border-radius: 8px;
}

.remove-preview {
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
}

.audio-preview,
.file-preview {
    padding: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 120px;
}

.audio-preview i,
.file-preview i {
    font-size: 1.2rem;
    color: var(--primary-color);
}

.audio-preview span,
.file-preview span {
    font-size: 0.8rem;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
}

/* تنسيق عرض الملفات في المحادثة */
.message-attachment {
    margin-top: 0.5rem;
    border-radius: 8px;
    overflow: hidden;
    max-width: 300px;
}

.message-image {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    cursor: pointer;
}

.message-audio {
    width: 100%;
    background: rgba(0,0,0,0.05);
    padding: 0.5rem;
    border-radius: 8px;
}

.message-file {
    background: rgba(0,0,0,0.05);
    padding: 0.5rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.message-content-container {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-width: 100%;
}

.message-text {
    margin-bottom: 4px;
    white-space: pre-wrap;
    word-break: break-word;
}

.attachment-preview {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    margin-top: 4px;
}

.image-preview {
    cursor: pointer;
    max-width: 300px;
    max-height: 300px;
}

.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.attachment-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.image-preview:hover .attachment-overlay {
    opacity: 1;
}

.attachment-overlay i {
    color: white;
    font-size: 24px;
}

.audio-container {
    background: rgba(0,0,0,0.05);
    padding: 8px;
    border-radius: 8px;
    width: 250px;
}

.audio-info {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.audio-name {
    font-size: 14px;
    color: inherit;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

audio {
    width: 100%;
    height: 36px;
}

.file-container {
    background: rgba(0,0,0,0.05);
    padding: 12px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    width: 250px;
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    display: block;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-size {
    display: block;
    font-size: 12px;
    color: rgba(0,0,0,0.5);
}

.download-button {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: background-color 0.2s ease;
}

.download-button:hover {
    background-color: var(--secondary-color);
}

.message-footer {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: rgba(0,0,0,0.5);
    margin-top: 4px;
}

.message-status {
    font-size: 12px;
    color: var(--primary-color);
}

.media-preview-container {
    background: rgba(0,0,0,0.9) !important;
    padding: 0 !important;
}

.media-preview-image {
    max-height: 90vh !important;
    object-fit: contain !important;
}

/* تنسيقات عامة للمرفقات */
.message-content-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-width: 100%;
}

.message-text {
    margin-bottom: 4px;
    white-space: pre-wrap;
    word-break: break-word;
}

.message-attachment {
    margin-top: 8px;
    border-radius: 8px;
    overflow: hidden;
}

/* تنسيقات الصور */
.image-preview {
    position: relative;
    cursor: pointer;
    max-width: 200px;
    border-radius: 8px;
    overflow: hidden;
}

.message-image {
    width: 100%;
    height: auto;
    display: block;
}

.attachment-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.image-preview:hover .attachment-overlay {
    opacity: 1;
}

.attachment-overlay i {
    color: white;
    font-size: 24px;
}

/* تنسيقات الملفات الصوتية */
.audio-container {
    background: rgba(0, 0, 0, 0.05);
    padding: 12px;
    border-radius: 8px;
    width: 250px;
}

.audio-info {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.audio-name {
    font-size: 14px;
    color: inherit;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.message-audio {
    width: 100%;
    height: 36px;
}

/* تنسيقات الملفات العامة */
.file-container {
    background: rgba(0, 0, 0, 0.05);
    padding: 12px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    width: 250px;
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    display: block;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-size {
    display: block;
    font-size: 12px;
    color: rgba(0, 0, 0, 0.5);
}

.download-button {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: background-color 0.2s ease;
}

.download-button:hover {
    background-color: var(--secondary-color);
}

/* تنسيقات تذييل الرسالة */
.message-footer {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: rgba(0, 0, 0, 0.5);
    margin-top: 4px;
}

.message-status {
    font-size: 12px;
    color: var(--primary-color);
}

/* تنسيقات نافذة معاينة الوسائط */
.media-preview-container {
    background: rgba(0, 0, 0, 0.9) !important;
    padding: 0 !important;
}

.media-preview-image {
    max-height: 90vh !important;
    object-fit: contain !important;
}
/* تحديث أنماط الرسائل والمرفقات */
.message {
    max-width: 75%;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 12px;
    position: relative;
    word-wrap: break-word;
}

.message-sent {
    background: var(--primary-color);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
}

.message-received {
    background: white;
    color: black;
    margin-right: auto;
    border-bottom-left-radius: 4px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.message-text {
    margin-bottom: 5px;
    line-height: 1.4;
}

.attachment-preview {
    margin-top: 5px;
    border-radius: 8px;
    overflow: hidden;
    max-width: 300px;
}

.message-image {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.message-image:hover {
    transform: scale(1.02);
}

.message-audio-wrapper {
    margin-top: 5px;
    background: rgba(255,255,255,0.1);
    padding: 8px;
    border-radius: 8px;
    width: 250px;
}

.message-received .message-audio-wrapper {
    background: rgba(0,0,0,0.05);
}

.message-audio {
    width: 100%;
    height: 36px;
}

.audio-info {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 5px;
    font-size: 12px;
}

.message-file-wrapper {
    margin-top: 5px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,0.1);
    padding: 8px 12px;
    border-radius: 8px;
    width: 250px;
}

.message-received .message-file-wrapper {
    background: rgba(0,0,0,0.05);
}

.file-info {
    display: flex;
    align-items: center;
    gap: 8px;
    max-width: calc(100% - 40px);
}

.file-info i {
    font-size: 20px;
}

.file-info span {
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-info small {
    font-size: 12px;
    opacity: 0.7;
}

.file-download {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    color: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: background-color 0.2s ease;
}

.message-received .file-download {
    background: var(--primary-color);
    color: white;
}

.file-download:hover {
    background: rgba(255,255,255,0.3);
}

.message-received .file-download:hover {
    background: var(--secondary-color);
}

.message-time {
    font-size: 12px;
    opacity: 0.7;
    margin-top: 5px;
    text-align: right;
}

/* أنماط عرض الصورة في وضع ملء الشاشة */
.full-image-container {
    background: rgba(0, 0, 0, 0.9) !important;
}

.full-image {
    max-height: 90vh !important;
    max-width: 90vw !important;
    object-fit: contain !important;
}

/* تحديث أنماط الرسائل */
.message {
    max-width: 75%;
    margin: 2px 15px;
    padding: 8px 12px;
    border-radius: 7.5px;
    position: relative;
    word-wrap: break-word;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
}

/* الرسائل المرسلة */
.message-sent {
    background: #e7ffdb; /* لون خلفية الرسائل المرسلة في الواتساب */
    color: #303030;
    margin-left: auto;
    margin-right: 15px;
    border-top-right-radius: 7.5px;
    border-bottom-right-radius: 0;
}

/* الرسائل المستلمة */
.message-received {
    background: white;
    color: #303030;
    margin-right: auto;
    margin-left: 15px;
    border-top-left-radius: 7.5px;
    border-bottom-left-radius: 0;
}

/* ذيل الرسالة (السهم) */
.message-sent:after,
.message-received:after {
    content: "";
    position: absolute;
    bottom: 0;
    width: 12px;
    height: 12px;
}

.message-sent:after {
    right: -12px;
    border-right: 6px solid transparent;
    border-left: 6px solid #e7ffdb;
    border-bottom: 6px solid #e7ffdb;
    border-top: 6px solid transparent;
}

.message-received:after {
    left: -12px;
    border-left: 6px solid transparent;
    border-right: 6px solid white;
    border-bottom: 6px solid white;
    border-top: 6px solid transparent;
}

/* وقت الرسالة */
.message-time {
    font-size: 11px;
    color: #667781;
    margin-top: 2px;
    margin-left: 4px;
    margin-right: 4px;
    float: right;
}

/* تنسيق المحتوى */
.message-text {
    font-size: 14.2px;
    line-height: 19px;
    margin-right: 50px; /* مساحة للوقت */
}

/* المرفقات */
.message-attachment {
    margin-top: 5px;
    margin-bottom: 5px;
    border-radius: 6px;
    overflow: hidden;
}

.message-image {
    max-width: 300px;
    max-height: 300px;
    border-radius: 6px;
    object-fit: cover;
}

/* الملفات الصوتية */
.message-audio-wrapper {
    background: transparent;
    padding: 5px;
    border-radius: 6px;
    margin-top: 5px;
}

.message-audio {
    width: 100%;
    height: 40px;
    border-radius: 20px;
}

/* الملفات العامة */
.message-file-wrapper {
    background: rgba(0,0,0,0.05);
    padding: 10px;
    border-radius: 6px;
    margin-top: 5px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: 500;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-size {
    font-size: 12px;
    color: #667781;
}

/* علامات حالة الرسالة */
.message-status {
    float: right;
    font-size: 14px;
    margin-left: 5px;
    margin-top: 3px;
    color: #85bff0; /* لون علامات القراءة في الواتساب */
}


.attachment-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    border-radius: 8px;
}

.loading-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 8px;
}

.check-marks {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #4CAF50;
    font-size: 24px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.check-marks.visible {
    opacity: 1;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* حاوية الرسائل */
.chat-messages {
    background-color: #efeae2; /* خلفية الواتساب */
    background-image: url("");
}

/* تنسيق أزرار الاتصال */
.call-buttons {
    display: flex;
    gap: 8px;
    margin-right: 12px;
}

.call-button {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    color: white;
}

/* تأثير الخلفية المتحركة */
.call-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.1);
    transform: scale(0);
    border-radius: 50%;
    transition: transform 0.3s ease;
}

.call-button:hover::before {
    transform: scale(1);
}

/* أنماط زر مكالمة الفيديو */
.video-call {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
}

.video-call:hover {
    background: linear-gradient(135deg, #45a049, #3d8b40);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
}

/* أنماط زر المكالمة الصوتية */
.voice-call {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
}

.voice-call:hover {
    background: linear-gradient(135deg, #1976D2, #1565C0);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(33, 150, 243, 0.4);
}

/* تأثير النقر */
.call-button:active {
    transform: scale(0.95);
}

/* أيقونات الاتصال */
.call-button i {
    font-size: 18px;
    position: relative;
    z-index: 2;
}

/* تنسيق علامة الحالة */
.call-button::after {
    content: '';
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4CAF50;
    top: 4px;
    right: 4px;
    border: 2px solid white;
    display: none;
}

.call-button.available::after {
    display: block;
}

/* تأثير النبض عند الاتصال */
@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
    }
}

.call-button.calling {
    animation: pulse 1.5s infinite;
}

/* تنسيقات حالة عدم التوفر */
.call-button.disabled {
    background: #9e9e9e;
    cursor: not-allowed;
    opacity: 0.7;
}

.call-button.disabled:hover {
    transform: none;
    box-shadow: none;
}

/* تنسيق القائمة المنسدلة وتحسين موقعها */
.menu-trigger {
    margin-right: 8px;
}

/* تحسين التجاوب مع الشاشات الصغيرة */
@media (max-width: 480px) {
    .call-buttons {
        gap: 4px;
        margin-right: 8px;
    }
    
    .call-button {
        width: 36px;
        height: 36px;
    }
    
    .call-button i {
        font-size: 16px;
    }
}

/* تنسيقات عداد المكالمة */
.call-timer {
    font-size: 1.2rem;
    color: white;
    text-align: center;
    margin-top: 8px;
    font-family: monospace;
    background: rgba(0, 0, 0, 0.3);
    padding: 4px 12px;
    border-radius: 16px;
    display: inline-block;
}

/* تحديث تنسيقات حالة المكالمة */
.call-status {
    color: white;
    text-align: center;
    margin-top: 12px;
    font-size: 1rem;
    opacity: 0.9;
}

/* تنسيقات أزرار التحكم في الصوت */
.audio-controls {
    display: flex;
    gap: 16px;
    justify-content: center;
    margin-top: 16px;
}

.audio-control-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.audio-control-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
}

.audio-control-btn.muted {
    background: rgba(255, 68, 68, 0.6);
}

/* تنسيقات عنصر الصوت */
#remote-audio {
    display: none;
}

/* تأثيرات انتقالية */
@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
    }
}

.calling .audio-control-btn {
    animation: pulse 1.5s infinite;
}

    </style>
</head>
<body>
    <!-- الحاوية الرئيسية -->
    <div class="container">
        <!-- حاوية تسجيل الدخول -->
        <div id="auth-container" class="auth-container">
            <div class="app-logo">
                <i class="fas fa-comments"></i>
                <h1>تطبيق المحادثة</h1>
            </div>

            <!-- نموذج تسجيل الدخول -->
            <div id="login-form">
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="login-email" placeholder="البريد الإلكتروني" required>
                    <label for="login-email">
                        <i class="fas fa-envelope me-2"></i>
                        البريد الإلكتروني
                    </label>
                </div>

                <div class="form-floating mb-4">
                    <input type="password" class="form-control" id="login-password" placeholder="كلمة المرور" required>
                    <label for="login-password">
                        <i class="fas fa-lock me-2"></i>
                        كلمة المرور
                    </label>
                </div>

                <button type="button" onclick="login()" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>
                    تسجيل الدخول
                </button>

                <button type="button" onclick="showRegistration()" class="btn btn-outline w-100">
                    <i class="fas fa-user-plus me-2"></i>
                    إنشاء حساب جديد
                </button>

                <!-- أزرار مواقع التواصل -->
                <div class="social-auth">
                    <div class="social-auth-divider">
                        <span>أو سجل الدخول باستخدام</span>
                    </div>
                    <div class="social-buttons">
                        <button class="social-button facebook">
                            <i class="fab fa-facebook-f"></i>
                        </button>
                        <button class="social-button google">
                            <i class="fab fa-google"></i>
                        </button>
                        <button class="social-button twitter">
                            <i class="fab fa-twitter"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- نموذج التسجيل -->
            <div id="registration-form" class="registration-form">
                <h3 class="text-center mb-4">إنشاء حساب جديد</h3>

                <div class="form-floating mb-3">
                    <input type="file" class="form-control" id="reg-avatar" accept="image/*">
                    <label for="reg-avatar">
                        <i class="fas fa-image me-2"></i>
                        الصورة الشخصية
                    </label>
                </div>
                
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="reg-username" placeholder="اسم المستخدم" required>
                    <label for="reg-username">
                        <i class="fas fa-user me-2"></i>
                        اسم المستخدم
                    </label>
                </div>

                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="reg-email" placeholder="البريد الإلكتروني" required>
                    <label for="reg-email">
                        <i class="fas fa-envelope me-2"></i>
                        البريد الإلكتروني
                    </label>
                </div>

                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="reg-password" placeholder="كلمة المرور" required>
                    <label for="reg-password">
                        <i class="fas fa-lock me-2"></i>
                        كلمة المرور
                    </label>
                </div>

                <div class="form-floating mb-4">
                    <input type="password" class="form-control" id="reg-confirm-password" placeholder="تأكيد كلمة المرور" required>
                    <label for="reg-confirm-password">
                        <i class="fas fa-lock me-2"></i>
                        تأكيد كلمة المرور
                    </label>
                </div>

                <button type="button" onclick="register()" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-user-plus me-2"></i>
                    تسجيل
                </button>

                <button type="button" onclick="showLogin()" class="btn btn-outline w-100">
                    <i class="fas fa-arrow-right me-2"></i>
                    العودة لتسجيل الدخول
                </button>
            </div>
        </div>

        <!-- حاوية قائمة المستخدمين -->
        <div id="users-container" class="users-container">
            <div class="chat-header">
                <div class="header-container">
                    <div class="user-info-section">
                        <img id="current-user-avatar" src="/api/placeholder/45/45" alt="الصورة الشخصية" class="user-avatar">
                        <div class="user-details">
                            <h5 class="user-name" id="current-user-name">اسم المستخدم</h5>
                            <small class="user-id" id="current-user-id">المعرف: </small>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="menu-trigger" onclick="toggleUserMenu(event)">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="menu-dropdown">
                            <div class="menu-header">
                                <div class="menu-user-info">
                                    <img src="/api/placeholder/45/45" alt="" class="menu-avatar">
                                    <div class="menu-user-details">
                                        <span class="menu-username"></span>
                                        <small class="menu-email"></small>
                                    </div>
                                </div>
                            </div>
                            <div class="menu-items">
                                <a href="javascript:void(0)" class="menu-item" onclick="handleMenuClick('home', event)">
                                    <i class="fas fa-home"></i>
                                    <span>الصفحة الرئيسية</span>
                                </a>
                                <a href="javascript:void(0)" class="menu-item" onclick="handleMenuClick('requests', event)">
                                    <i class="fas fa-user-plus"></i>
                                    <span>طلبات الصداقة</span>
                                    <span class="menu-badge" id="requests-badge">0</span>
                                </a>
                                <div class="menu-divider"></div>
                                <a href="javascript:void(0)" class="menu-item" onclick="handleMenuClick('logout', event)">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>تسجيل الخروج</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="users-list" class="users-list">
                <!-- سيتم إضافة المستخدمين هنا ديناميكياً -->
            </div>
        </div>

        <!-- حاوية المحادثة -->
        <div id="chat-container" class="chat-container">
            <div class="chat-header">
                <div class="header-container">
                    <div class="header-left">
                        <button class="back-button" onclick="showUsersList()">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <button class="call-button voice-call" onclick="startCall('voice')">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="call-button video-call" onclick="startCall('video')">
                            <i class="fas fa-video"></i>
                        </button>
                        <div class="user-info-section">
                            <img id="chat-user-avatar" src="/api/placeholder/45/45" alt="الصورة الشخصية" class="user-avatar">
                            <div class="user-details">
                                <h5 class="user-name" id="chat-user-name">اسم المستخدم</h5>
                                <small class="user-id" id="chat-user-id">المعرف: </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="messages-container">
                <!-- سيتم إضافة الرسائل هنا ديناميكياً -->
            </div>

            <div class="chat-input">
                <form id="message-form" onsubmit="sendMessage(event)">
                    <div class="input-wrapper">
                        <div class="message-input-container">
                            <div class="preview-area" id="file-preview-area" style="display: none;">
                                <div class="selected-files-container" id="selected-files-container"></div>
                            </div>
                            <input type="text" class="message-input" id="message-input" placeholder="اكتب رسالتك هنا...">
                        </div>
                        
                        <div class="attachment-buttons">
                            <button type="button" class="attachment-btn" onclick="document.getElementById('image-upload').click()">
                                <i class="fas fa-image"></i>
                            </button>
                            <button type="button" class="attachment-btn" onclick="document.getElementById('audio-upload').click()">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button type="button" class="attachment-btn" onclick="document.getElementById('file-upload').click()">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button type="submit" class="send-button">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        
                        <input type="file" id="image-upload" accept="image/*" multiple style="display: none" onchange="handleFileSelection(event, 'image')">
                        <input type="file" id="audio-upload" accept="audio/*" multiple style="display: none" onchange="handleFileSelection(event, 'audio')">
                        <input type="file" id="file-upload" accept="*/*" multiple style="display: none" onchange="handleFileSelection(event, 'file')">
                    </div>
                </form>
            </div>
        </div>

        <div id="call-interface" class="call-interface">
            <div class="call-container">
                <img id="caller-avatar" src="" alt="صورة المتصل" class="caller-avatar">
                <h3 id="caller-name" class="caller-name"></h3>
                <p id="call-status" class="call-status"></p>
                <div id="call-timer" class="call-timer">00:00</div>
                <audio id="remote-audio" autoplay></audio>
                <video id="local-video" autoplay muted playsinline></video>
                <video id="remote-video" autoplay playsinline></video>
        
                <audio id="remote-audio" autoplay></audio>
                
                <div class="call-controls">
                    <button class="control-button toggle-mic" onclick="toggleMic()">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="control-button toggle-speaker" onclick="toggleSpeaker()">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button class="control-button end-call" onclick="endCall()">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
        </div>
     <!-- المكتبات المطلوبة -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
     <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
     <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
     <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
     <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
 
     <script>
         // تهيئة Firebase
         const firebaseConfig = {
             apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
             authDomain: "messageemeapp.firebaseapp.com",
             databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
             projectId: "messageemeapp",
             storageBucket: "messageemeapp.appspot.com",
             messagingSenderId: "255034474844",
             appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
         };
 
         firebase.initializeApp(firebaseConfig);
         const auth = firebase.auth();
         const database = firebase.database();
         const storage = firebase.storage();
 
           let currentUser = null;
         let currentChatUser = null;
 
         // توليد معرف المستخدم (6 أرقام)
         function generateUserId() {
             return Math.floor(100000 + Math.random() * 900000).toString();
         }
 
         // التسجيل المحدث
         // احذف الدالة القديمة للتسجيل واستبدلها بهذه الدالة
 
 
 // دالة توليد معرف المستخدم
 function generateUserId() {
     return Math.floor(100000 + Math.random() * 900000).toString();
 }
 
 // تحديث دالة تسجيل الدخول لتضمين المعرف
 async function login() {
     const email = document.getElementById('login-email').value;
     const password = document.getElementById('login-password').value;
 
     try {
         const userCredential = await auth.signInWithEmailAndPassword(email, password);
         const user = userCredential.user;
         
         const snapshot = await database.ref(`users/${user.uid}`).once('value');
         const userData = snapshot.val();
         
         currentUser = {
             uid: user.uid,
             username: userData.username,
             userId: userData.userId, // إضافة المعرف
             avatarUrl: userData.avatarUrl || '/api/placeholder/45/45'
         };
 
         showUsersList(); // عرض قائمة المستخدمين بدلاً من واجهة الدردشة
     } catch (error) {
         alert(`خطأ في تسجيل الدخول: ${error.message}`);
     }
 }
       // عرض قائمة المستخدمين
         function showUsersList() {
             document.getElementById('auth-container').style.display = 'none';
             document.getElementById('chat-container').style.display = 'none';
             document.getElementById('users-container').style.display = 'block';
             document.getElementById('current-user-name').textContent = currentUser.username;
             document.getElementById('current-user-id').textContent = `المعرف: ${currentUser.userId}`;
             document.getElementById('current-user-avatar').src = currentUser.avatarUrl;
             loadUsers();
         }
 
         // تحميل المستخدمين
         async function loadUsers() {
             const usersList = document.getElementById('users-list');
             usersList.innerHTML = '';
 
             const snapshot = await database.ref('users').once('value');
             const users = snapshot.val();
 
             for (const [uid, userData] of Object.entries(users)) {
                 if (uid === currentUser.uid) continue;
 
                 const userElement = document.createElement('div');
                 userElement.className = 'user-list-item';
                 userElement.innerHTML = `
                     <img src="${userData.avatarUrl || '/api/placeholder/45/45'}" alt="" class="user-avatar">
                     <div class="user-info">
                         <h6 class="mb-0">${userData.username}</h6>
                         <small class="user-id">المعرف: ${userData.userId}</small>
                     </div>
                 `;
 
                 userElement.onclick = () => promptForUserId(uid, userData);
                 usersList.appendChild(userElement);
             }
         }
 
         // طلب معرف المستخدم قبل بدء المحادثة
         function promptForUserId(uid, userData) {
             const enteredId = prompt('الرجاء إدخال معرف المستخدم المكون من 6 أرقام:');
             
             if (enteredId === userData.userId) {
                 startChat(uid, userData);
             } else {
                 alert('معرف المستخدم غير صحيح');
             }
         }
 
         // بدء المحادثة
         // تحديث دالة بدء المحادثة
 
 
 
 // دالة للحصول على معرف المحادثة
 function getChatId(uid1, uid2) {
     // ترتيب المعرفات تصاعدياً لضمان ثبات معرف المحادثة
     return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
 }
 
 // تحديث دالة تحميل الرسائل
 function loadMessages() {
     const messagesContainer = document.getElementById('messages-container');
     messagesContainer.innerHTML = ''; // تنظيف الرسائل السابقة
     
     const chatId = getChatId(currentUser.uid, currentChatUser.uid);
     
     // الاستماع للرسائل الجديدة في المحادثة المحددة
     database.ref(`chats/${chatId}/messages`).on('child_added', (snapshot) => {
         const messageData = snapshot.val();
         const messageElement = document.createElement('div');
         messageElement.classList.add('message');
         
         // تحديد نوع الرسالة (مرسلة أو مستلمة)
         const isSender = messageData.senderId === currentUser.uid;
         messageElement.classList.add(isSender ? 'message-sent' : 'message-received');
         
         // إنشاء محتوى الرسالة
         const messageContent = document.createElement('div');
         messageContent.classList.add('message-content');
         
         // إضافة اسم المرسل للرسائل المستلمة فقط
         if (!isSender) {
             const senderAvatar = document.createElement('img');
             senderAvatar.src = currentChatUser.avatarUrl || '/api/placeholder/45/45';
             senderAvatar.classList.add('user-avatar', 'me-2');
             messageElement.appendChild(senderAvatar);
 
             const senderName = document.createElement('div');
             senderName.classList.add('sender-name', 'small', 'text-muted', 'mb-1');
             senderName.textContent = messageData.senderName;
             messageElement.appendChild(senderName);
         }
         
         messageContent.textContent = messageData.message;
         messageElement.appendChild(messageContent);
         
         // إضافة التوقيت
         const timestamp = document.createElement('div');
         timestamp.classList.add('message-time', 'small', 'text-muted', 'mt-1');
         const messageDate = new Date(messageData.timestamp);
         timestamp.textContent = messageDate.toLocaleTimeString('ar-EG', {
             hour: '2-digit',
             minute: '2-digit'
         });
         messageElement.appendChild(timestamp);
         
         messagesContainer.appendChild(messageElement);
         messagesContainer.scrollTop = messagesContainer.scrollHeight;
     });
 
     // إلغاء الاستماع للمحادثات السابقة عند تغيير المستخدم
     return () => {
         database.ref(`chats/${chatId}/messages`).off();
     };
 }
 
 // تحديث دالة بدء المحادثة
 
 
         // تحديث وظيفة تحميل الرسائل
         function loadMessages() {
             const messagesContainer = document.getElementById('messages-container');
             
             database.ref('messages').on('child_added', (snapshot) => {
                 const messageData = snapshot.val();
                 
                 if ((messageData.senderId === currentUser.uid && 
                      messageData.receiverId === currentChatUser.uid) ||
                     (messageData.senderId === currentChatUser.uid && 
                      messageData.receiverId === currentUser.uid)) {
                     
                     const messageElement = document.createElement('div');
                     messageElement.classList.add('message');
                     
                     if (messageData.senderId === currentUser.uid) {
                         messageElement.classList.add('message-sent');
                     } else {
                         messageElement.classList.add('message-received');
                     }
 
                     const messageContent = document.createElement('div');
                     messageContent.classList.add('message-content');
                     messageContent.textContent = messageData.message;
                     
                     messageElement.appendChild(messageContent);
 
                     const timestamp = document.createElement('div');
                     timestamp.classList.add('message-time', 'small', 'text-muted', 'mt-1');
                     const messageDate = new Date(messageData.timestamp);
                     timestamp.textContent = messageDate.toLocaleTimeString('ar-EG', {
                         hour: '2-digit',
                         minute: '2-digit'
                     });
                     messageElement.appendChild(timestamp);
 
                     messagesContainer.appendChild(messageElement);
                     messagesContainer.scrollTop = messagesContainer.scrollHeight;
                 }
             });
         }
 
         auth.onAuthStateChanged(async (user) => {
             try {
                 if (user) {
                     const snapshot = await database.ref(`users/${user.uid}`).once('value');
                     const userData = snapshot.val();
                     
                     if (userData) {
                         currentUser = {
                             uid: user.uid,
                             username: userData.username,
                             userId: userData.userId,
                             email: user.email,
                             avatarUrl: userData.avatarUrl || defaultAvatar
                         };
                         
                         showUsersList();
                         initializeUI();
                         setupCallListeners();
                     }
                 } else {
                     currentUser = null;
                     document.getElementById('chat-container').style.display = 'none';
                     document.getElementById('users-container').style.display = 'none';
                     document.getElementById('auth-container').style.display = 'block';
                     showLogin();
                 }
             } catch (error) {
                 console.error('Error in auth state change:', error);
             }
         });
 
         // إظهار نموذج التسجيل
         function showRegistration() {
             document.getElementById('login-form').style.display = 'none';
             document.getElementById('registration-form').style.display = 'block';
         }
 
         // إظهار نموذج تسجيل الدخول
         function showLogin() {
             document.getElementById('registration-form').style.display = 'none';
             document.getElementById('login-form').style.display = 'block';
         }
 
         // تسجيل الدخول
         async function login() {
             const email = document.getElementById('login-email').value;
             const password = document.getElementById('login-password').value;
 
             try {
                 const userCredential = await auth.signInWithEmailAndPassword(email, password);
                 const user = userCredential.user;
                 
                 // جلب بيانات المستخدم
                 const snapshot = await database.ref(`users/${user.uid}`).once('value');
                 const userData = snapshot.val();
                 
                 currentUser = {
                     uid: user.uid,
                     username: userData.username,
                     avatarUrl: userData.avatarUrl || '/api/placeholder/45/45'
                 };
 
                 showChatInterface();
             } catch (error) {
                 alert(`خطأ في تسجيل الدخول: ${error.message}`);
             }
         }
 
         // التسجيل
         async function register() {
             try {
                 const username = document.getElementById('reg-username').value;
                 const email = document.getElementById('reg-email').value;
                 const password = document.getElementById('reg-password').value;
                 const confirmPassword = document.getElementById('reg-confirm-password').value;
                 const avatarFile = document.getElementById('reg-avatar').files[0];
         
                 if (!username || !email || !password) {
                     alert('الرجاء إكمال جميع الحقول المطلوبة');
                     return;
                 }
         
                 if (password !== confirmPassword) {
                     alert('كلمات المرور غير متطابقة');
                     return;
                 }
         
                 // إنشاء حساب المستخدم
                 const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                 const user = userCredential.user;
                 const userId = generateUserId();
         
                 let avatarUrl = '/api/placeholder/45/45';
         
                 // رفع الصورة إذا تم اختيارها
                 if (avatarFile) {
                     const storageRef = storage.ref(`avatars/${user.uid}`);
                     await storageRef.put(avatarFile);
                     avatarUrl = await storageRef.getDownloadURL();
                 }
         
                 // حفظ بيانات المستخدم في قاعدة البيانات
                 const userData = {
                     username: username,
                     email: email,
                     userId: userId,
                     avatarUrl: avatarUrl,
                     createdAt: firebase.database.ServerValue.TIMESTAMP
                 };
         
                 // حفظ البيانات في Firebase Realtime Database
                 await database.ref(`users/${user.uid}`).set(userData);
         
                 // تحديث المستخدم الحالي
                 currentUser = {
                     uid: user.uid,
                     username: username,
                     userId: userId,
                     avatarUrl: avatarUrl
                 };
         
                 console.log('تم تسجيل المستخدم بنجاح:', userData); // للتأكد من حفظ البيانات
                 showUsersList();
         
             } catch (error) {
                 console.error('خطأ في التسجيل:', error);
                 alert(`خطأ في التسجيل: ${error.message}`);
             }
         }
         
         // تحديث دالة تحميل المستخدمين
         async function loadUsers() {
             try {
                 const usersList = document.getElementById('users-list');
                 usersList.innerHTML = '';
         
                 const snapshot = await database.ref('users').once('value');
                 const users = snapshot.val();
         
                 if (!users) {
                     usersList.innerHTML = '<div class="p-3 text-center">لا يوجد مستخدمين حالياً</div>';
                     return;
                 }
         
                 for (const [uid, userData] of Object.entries(users)) {
                     if (uid === currentUser.uid) continue;
         
                     const userElement = document.createElement('div');
                     userElement.className = 'user-list-item';
                     userElement.innerHTML = `
                         <img src="${userData.avatarUrl || '/api/placeholder/45/45'}" alt="" class="user-avatar">
                         <div class="user-info">
                             <h6 class="mb-0">${userData.username}</h6>
                             <small class="user-id">المعرف: ${userData.userId}</small>
                         </div>
                     `;
         
                     userElement.onclick = () => promptForUserId(uid, userData);
                     usersList.appendChild(userElement);
                 }
             } catch (error) {
                 console.error('خطأ في تحميل المستخدمين:', error);
                 alert('حدث خطأ في تحميل قائمة المستخدمين');
             }
         }
         
         // تحديث دالة التحقق من معرف المستخدم
         function promptForUserId(uid, userData) {
             const enteredId = prompt('الرجاء إدخال معرف المستخدم المكون من 6 أرقام:');
             
             if (!enteredId) return;
             
             if (enteredId === userData.userId) {
                 startChat(uid, userData);
             } else {
                 alert('معرف المستخدم غير صحيح');
             }
         }
         // تسجيل الخروج
         function logout() {
             auth.signOut().then(() => {
                 document.getElementById('chat-container').style.display = 'none';
                 document.getElementById('auth-container').style.display = 'block';
                 currentUser = null;
                 showLogin();
             }).catch((error) => {
                 alert(`خطأ في تسجيل الخروج: ${error.message}`);
             });
         }
 
         // إظهار واجهة المحادثة
         function showChatInterface() {
             document.getElementById('auth-container').style.display = 'none';
             document.getElementById('chat-container').style.display = 'block';
             document.getElementById('current-user-name').textContent = currentUser.username;
             loadMessages();
         }
 
         // إرسال رسالة
         async function sendMessage(event) {
             event.preventDefault();
             const messageInput = document.getElementById('message-input');
             const message = messageInput.value.trim();
             
             if (message && currentUser) {
                 try {
                     await database.ref('messages').push({
                         uid: currentUser.uid,
                         username: currentUser.username,
                         message: message,
                         timestamp: firebase.database.ServerValue.TIMESTAMP
                     });
                     
                     messageInput.value = '';
                 } catch (error) {
                     alert(`خطأ في إرسال الرسالة: ${error.message}`);
                 }
             }
         }
 
         // تحميل الرسائل
         function loadMessages() {
             const messagesContainer = document.getElementById('messages-container');
             
             database.ref('messages').on('child_added', (snapshot) => {
                 const message = snapshot.val();
                 const messageElement = document.createElement('div');
                 messageElement.classList.add('message');
                 
                 if (message.uid === currentUser.uid) {
                     messageElement.classList.add('message-sent');
                 } else {
                     messageElement.classList.add('message-received');
                 }
 
                 const messageContent = document.createElement('div');
                 messageContent.classList.add('message-content');
                 
                 if (message.uid !== currentUser.uid) {
                     const senderName = document.createElement('div');
                     senderName.classList.add('sender-name', 'small', 'text-muted', 'mb-1');
                     senderName.textContent = message.username;
                     messageElement.appendChild(senderName);
                 }
 
                 messageContent.textContent = message.message;
                 messageElement.appendChild(messageContent);
 
                 const timestamp = document.createElement('div');
                 timestamp.classList.add('message-time', 'small', 'text-muted', 'mt-1');
                 const messageDate = new Date(message.timestamp);
                 timestamp.textContent = messageDate.toLocaleTimeString('ar-EG', {
                     hour: '2-digit',
                     minute: '2-digit'
                 });
                 messageElement.appendChild(timestamp);
 
                 messagesContainer.appendChild(messageElement);
                 messagesContainer.scrollTop = messagesContainer.scrollHeight;
             });
         }
 
         // التحقق من حالة المصادقة عند تحميل الصفحة
         auth.onAuthStateChanged(async (user) => {
             if (user) {
                 const snapshot = await database.ref(`users/${user.uid}`).once('value');
                 const userData = snapshot.val();
                 
                 currentUser = {
                     uid: user.uid,
                     username: userData.username,
                     avatarUrl: userData.avatarUrl || '/api/placeholder/45/45'
                 };
                 
                 showChatInterface();
             } else {
                 document.getElementById('chat-container').style.display = 'none';
                 document.getElementById('auth-container').style.display = 'block';
                 showLogin();
             }
         });
 
     // Function to get chat ID
     function getChatId(uid1, uid2) {
         return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
     }
 
     // Update login function to include userId
     async function login() {
         const email = document.getElementById('login-email').value;
         const password = document.getElementById('login-password').value;
 
         try {
             const userCredential = await auth.signInWithEmailAndPassword(email, password);
             const user = userCredential.user;
             
             const snapshot = await database.ref(`users/${user.uid}`).once('value');
             const userData = snapshot.val();
             
             currentUser = {
                 uid: user.uid,
                 username: userData.username,
                 userId: userData.userId,
                 avatarUrl: userData.avatarUrl || '/api/placeholder/45/45'
             };
 
             showUsersList();
         } catch (error) {
             alert(`خطأ في تسجيل الدخول: ${error.message}`);
         }
     }
 
     // Show users list
     function showUsersList() {
         document.getElementById('auth-container').style.display = 'none';
         document.getElementById('chat-container').style.display = 'none';
         document.getElementById('users-container').style.display = 'block';
         document.getElementById('current-user-name').textContent = currentUser.username;
         document.getElementById('current-user-id').textContent = `المعرف: ${currentUser.userId}`;
         document.getElementById('current-user-avatar').src = currentUser.avatarUrl;
         loadUsers();
     }
 
     // Load users
     async function loadUsers() {
         const usersList = document.getElementById('users-list');
         usersList.innerHTML = '';
 
         const snapshot = await database.ref('users').once('value');
         const users = snapshot.val();
 
         for (const [uid, userData] of Object.entries(users)) {
             if (uid === currentUser.uid) continue;
 
             const userElement = document.createElement('div');
             userElement.className = 'user-list-item';
             userElement.innerHTML = `
                 <img src="${userData.avatarUrl || '/api/placeholder/45/45'}" alt="" class="user-avatar">
                 <div class="user-info">
                     <h6 class="mb-0">${userData.username}</h6>
                     <small class="user-id">المعرف: ${userData.userId}</small>
                 </div>
             `;
 
             userElement.onclick = () => startChat(uid, userData);
             usersList.appendChild(userElement);
         }
     }
 
    // تحديث دالة بدء المحادثة
 function startChat(uid, userData) {
     currentChatUser = {
         uid,
         username: userData.username,
         avatarUrl: userData.avatarUrl || '/api/placeholder/45/45',
         userId: userData.userId
     };
 
     document.getElementById('users-container').style.display = 'none';
     document.getElementById('chat-container').style.display = 'block';
     
     // تحديث معلومات المستخدم في رأس المحادثة
     document.getElementById('chat-user-avatar').src = currentChatUser.avatarUrl;
     document.getElementById('chat-user-name').textContent = currentChatUser.username;
     document.getElementById('chat-user-id').textContent = `المعرف: ${currentChatUser.userId}`;
 
     // تنظيف وتحميل الرسائل
     document.getElementById('messages-container').innerHTML = '';
     
     // إنشاء معرف المحادثة
     const chatId = getChatId(currentUser.uid, currentChatUser.uid);
     
     // تحميل الرسائل الخاصة بهذه المحادثة
     loadMessages(chatId);
 
     // إضافة معالج لزر الرجوع في المتصفح
     window.history.pushState({ page: 'chat' }, '');
 }
 
 // تحديث دالة إرسال الرسائل
 async function sendMessage(event) {
     event.preventDefault();
     const messageInput = document.getElementById('message-input');
     const message = messageInput.value.trim();
     
     if (message && currentUser && currentChatUser) {
         try {
             const chatId = getChatId(currentUser.uid, currentChatUser.uid);
             
             await database.ref(`chats/${chatId}/messages`).push({
                 senderId: currentUser.uid,
                 receiverId: currentChatUser.uid,
                 senderName: currentUser.username,
                 message: message,
                 timestamp: firebase.database.ServerValue.TIMESTAMP
             });
             
             messageInput.value = '';
             messageInput.focus();
         } catch (error) {
             alert(`خطأ في إرسال الرسالة: ${error.message}`);
         }
     }
 }
 
 // تحديث دالة تحميل الرسائل
 function loadMessages(chatId) {
     const messagesContainer = document.getElementById('messages-container');
     messagesContainer.innerHTML = '';
     
     // إلغاء الاستماع للمحادثات السابقة
     if (window.currentMessagesRef) {
         window.currentMessagesRef.off();
     }
     
     // الاستماع للرسائل الجديدة
     window.currentMessagesRef = database.ref(`chats/${chatId}/messages`);
     window.currentMessagesRef.on('child_added', (snapshot) => {
         const messageData = snapshot.val();
         displayMessage(messageData);
     });
 }
 
 // دالة عرض الرسالة
 // تحديث دالة عرض الرسائل لدعم المرفقات
 
 
 // دالة معالجة اكتمال تحميل المرفق
 function handleAttachmentLoaded(attachmentId) {
     const loadingDiv = document.getElementById(`${attachmentId}-loading`);
     if (loadingDiv) {
         const spinner = loadingDiv.querySelector('.loading-spinner');
         const checkMarks = loadingDiv.querySelector('.check-marks');
         
         spinner.style.display = 'none';
         checkMarks.classList.add('visible');
         
         setTimeout(() => {
             loadingDiv.style.opacity = '0';
             setTimeout(() => {
                 loadingDiv.remove();
             }, 300);
         }, 1000);
     }
 }
 
 // دالة تنسيق الوقت
 function formatMessageTime(timestamp) {
     const date = new Date(timestamp);
     return date.toLocaleTimeString('ar-EG', {
         hour: '2-digit',
         minute: '2-digit'
     });
 }
 // دالة عرض الوسائط في نافذة منبثقة
 function showMediaPreview(url, type) {
     if (type === 'image') {
         Swal.fire({
             imageUrl: url,
             showCloseButton: true,
             showConfirmButton: false,
             customClass: {
                 container: 'media-preview-container',
                 image: 'media-preview-image'
             },
             background: 'rgba(0,0,0,0.9)',
             width: '100%',
             padding: 0,
             heightAuto: false
         });
     }
 }
 
 // دالة تنسيق حجم الملف
 function formatFileSize(bytes) {
     if (bytes === 0) return '0 Bytes';
     const k = 1024;
     const sizes = ['Bytes', 'KB', 'MB', 'GB'];
     const i = Math.floor(Math.log(bytes) / Math.log(k));
     return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
 }
 
 // دالة تنسيق وقت الرسالة
 function formatMessageTime(timestamp) {
     const date = new Date(timestamp);
     const now = new Date();
     const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
     
     if (diffDays === 0) {
         return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
     } else if (diffDays === 1) {
         return 'أمس';
     } else {
         return date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
     }
 }
 
 // تحديث دالة إرسال الرسالة
 async function sendMessage(event) {
     event.preventDefault();
     const messageInput = document.getElementById('message-input');
     const message = messageInput.value.trim();
     const selectedFiles = Array.from(document.querySelectorAll('.selected-file-preview'));
     
     if (!message && selectedFiles.length === 0) return;
     
     try {
        
 
         const chatId = getChatId(currentUser.uid, currentChatUser.uid);
         const messageData = {
             senderId: currentUser.uid,
             senderName: currentUser.username,
             message: message,
             timestamp: firebase.database.ServerValue.TIMESTAMP,
             attachments: []
         };
 
         // رفع الملفات المرفقة
         for (const filePreview of selectedFiles) {
             const file = filePreview.file;
             const type = filePreview.dataset.type;
             const fileRef = storage.ref(`chats/${currentUser.uid}/${Date.now()}_${file.name}`);
             
             await fileRef.put(file);
             const url = await fileRef.getDownloadURL();
             
             messageData.attachments.push({
                 type: type,
                 url: url,
                 name: file.name,
                 size: file.size
             });
         }
 
         // إرسال الرسالة
         await database.ref(`chats/${chatId}/messages`).push(messageData);
         
         // تنظيف الحقول
         messageInput.value = '';
         selectedFiles.forEach(preview => preview.remove());
         
         Swal.close();
     } catch (error) {
         console.error('خطأ في إرسال الرسالة:', error);
         Swal.fire({
             icon: 'error',
             title: 'خطأ في الإرسال',
             text: error.message
         });
     }
 }
     // Load messages
     function loadMessages() {
         const messagesContainer = document.getElementById('messages-container');
         messagesContainer.innerHTML = ''; 
         
         const chatId = getChatId(currentUser.uid, currentChatUser.uid);
         
         database.ref(`chats/${chatId}/messages`).on('child_added', (snapshot) => {
             const messageData = snapshot.val();
             const messageElement = document.createElement('div');
             messageElement.classList.add('message');
             
             const isSender = messageData.senderId === currentUser.uid;
             messageElement.classList.add(isSender ? 'message-sent' : 'message-received');
             
             const messageContent = document.createElement('div');
             messageContent.classList.add('message-content');
             
             if (!isSender) {
                 const senderAvatar = document.createElement('img');
                 senderAvatar.src = currentChatUser.avatarUrl || '/api/placeholder/45/45';
                 senderAvatar.classList.add('user-avatar', 'me-2');
                 messageElement.appendChild(senderAvatar);
 
                 const senderName = document.createElement('div');
                 senderName.classList.add('sender-name', 'small', 'text-muted', 'mb-1');
                 senderName.textContent = messageData.senderName;
                 messageElement.appendChild(senderName);
             }
             
             messageContent.textContent = messageData.message;
             messageElement.appendChild(messageContent);
             
             const timestamp = document.createElement('div');
             timestamp.classList.add('message-time', 'small', 'text-muted', 'mt-1');
             const messageDate = new Date(messageData.timestamp);
             timestamp.textContent = messageDate.toLocaleTimeString('ar-EG', {
                 hour: '2-digit',
                 minute: '2-digit'
             });
             messageElement.appendChild(timestamp);
             
             messagesContainer.appendChild(messageElement);
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
         });
 
         return () => {
             database.ref(`chats/${chatId}/messages`).off();
         };
     }
 
     // Send message
     async function sendMessage(event) {
         event.preventDefault();
         const messageInput = document.getElementById('message-input');
         const message = messageInput.value.trim();
         
         if (message && currentUser) {
             try {
                 const chatId = getChatId(currentUser.uid, currentChatUser.uid);
                 await database.ref(`chats/${chatId}/messages`).push({
                     senderId: currentUser.uid,
                     senderName: currentUser.username,
                     message: message,
                     timestamp: firebase.database.ServerValue.TIMESTAMP
                 });
                 
                 messageInput.value = '';
             } catch (error) {
                 alert(`خطأ في إرسال الرسالة: ${error.message}`);
             }
         }
     }
 
     // Handle back button press
     let backPressedOnce = false;
     window.addEventListener('popstate', () => {
         if (document.getElementById('chat-container').style.display === 'block') {
             showUsersList();
         } else if (backPressedOnce) {
             window.history.back();
         } else {
             backPressedOnce = true;
             alert('اضغط مرة أخرى للخروج');
             setTimeout(() => {
                 backPressedOnce = false;
             }, 2000);
         }
     });
 
 
     // إضافة النمط لأزرار الإضافة
 const style = document.createElement('style');
 style.textContent = `
     .friend-request-btn {
         padding: 5px 15px;
         border-radius: 20px;
         font-size: 0.8rem;
         transition: all 0.3s ease;
     }
 
     .pending-request {
         background-color: #FFA726;
         color: white;
     }
 
     .accept-request {
         background-color: #66BB6A;
         color: white;
     }
 
     .send-request {
         background-color: var(--primary-color);
         color: white;
     }
     
     .request-badge {
         position: fixed;
         top: 10px;
         left: 10px;
         background: #ff4444;
         color: white;
         border-radius: 50%;
         padding: 5px 10px;
         font-size: 12px;
         z-index: 1000;
     }
 `;
 document.head.appendChild(style);
 
 // دالة لإرسال طلب إضافة
 // دالة إرسال طلب صداقة
 async function sendFriendRequest(targetUserId) {
     try {
         const requestData = {
             senderId: currentUser.uid,
             senderName: currentUser.username,
             senderAvatar: currentUser.avatarUrl,
             status: 'pending',
             timestamp: firebase.database.ServerValue.TIMESTAMP
         };
 
         // إضافة الطلب إلى قاعدة البيانات
         await database.ref(`friendRequests/${targetUserId}/${currentUser.uid}`).set(requestData);
         
         alert('تم إرسال طلب الصداقة بنجاح');
     } catch (error) {
         console.error('خطأ في إرسال طلب الصداقة:', error);
         alert('حدث خطأ في إرسال الطلب');
     }
 }
 
 // دالة قبول طلب الصداقة
 async function acceptFriendRequest(senderId) {
     try {
         const updates = {};
         
         // تحديث حالة الطلب
         updates[`friendRequests/${currentUser.uid}/${senderId}/status`] = 'accepted';
         
         // إضافة العلاقة إلى قائمة الأصدقاء لكلا المستخدمين
         updates[`friends/${currentUser.uid}/${senderId}`] = true;
         updates[`friends/${senderId}/${currentUser.uid}`] = true;
         
         await database.ref().update(updates);
         
         alert('تم قبول طلب الصداقة');
         loadUsers(); // إعادة تحميل قائمة المستخدمين
     } catch (error) {
         console.error('خطأ في قبول طلب الصداقة:', error);
         alert('حدث خطأ في قبول الطلب');
     }
 }
 
 // دالة التحقق من حالة الصداقة
 async function checkFriendshipStatus(targetUserId) {
     try {
         // التحقق من وجود علاقة صداقة
         const friendshipSnapshot = await database.ref(`friends/${currentUser.uid}/${targetUserId}`).once('value');
         if (friendshipSnapshot.exists()) {
             return 'friends';
         }
         
         // التحقق من وجود طلب معلق
         const requestSnapshot = await database.ref(`friendRequests/${targetUserId}/${currentUser.uid}`).once('value');
         if (requestSnapshot.exists()) {
             return requestSnapshot.val().status;
         }
         
         return 'none';
     } catch (error) {
         console.error('خطأ في التحقق من حالة الصداقة:', error);
         return 'error';
     }
 }
 // تحديث دالة طلبات الصداقة
 function loadFriendRequests() {
     if (!currentUser?.uid) {
         console.log('No user logged in');
         return Promise.resolve([]);
     }
     
     return database.ref(`friendRequests/${currentUser.uid}`)
         .once('value')
         .then(snapshot => {
             const requests = snapshot.val() || {};
             return Object.values(requests)
                 .filter(req => req.status === 'pending');
         })
         .catch(error => {
             console.error('Error loading friend requests:', error);
             return [];
         });
 }
 
 
 let firebaseApp;
 try {
     // تحقق مما إذا كان Firebase مهيأ بالفعل
     if (!firebase.apps.length) {
         firebaseApp = firebase.initializeApp(firebaseConfig);
     } else {
         firebaseApp = firebase.app();
     }
     
     const auth = firebase.auth();
     const database = firebase.database();
     const storage = firebase.storage();
     
 } catch (error) {
     console.error('Error initializing Firebase:', error);
 }
 // تحديث دالة الاستماع لطلبات الصداقة
 function listenToFriendRequests() {
     if (!currentUser?.uid) {
         console.log('Cannot listen for friend requests - no user logged in');
         return;
     }
     
     database.ref(`friendRequests/${currentUser.uid}`).on('child_added', 
         snapshot => {
             const request = snapshot.val();
             if (request?.status === 'pending') {
                 loadUsers();
             }
         },
         error => {
             console.error('Error in friend requests listener:', error);
         }
     );
 }
 // دالة تحميل قائمة الأصدقاء
 async function loadFriendsList() {
     try {
         const friendsSnapshot = await database.ref(`friends/${currentUser.uid}`).once('value');
         const friends = friendsSnapshot.val() || {};
         
         // جلب معلومات الأصدقاء
         const friendsInfo = await Promise.all(
             Object.keys(friends).map(async (friendId) => {
                 const userSnapshot = await database.ref(`users/${friendId}`).once('value');
                 return {
                     id: friendId,
                     ...userSnapshot.val()
                 };
             })
         );
         
         return friendsInfo;
     } catch (error) {
         console.error('خطأ في تحميل قائمة الأصدقاء:', error);
         return [];
     }
 }
 
 // دالة لتحديث شكل زر الإضافة
 function updateRequestButton(userId, status) {
     const button = document.querySelector(`[data-user-id="${userId}"]`);
     if (!button) return;
 
     switch (status) {
         case 'pending':
             button.className = 'btn friend-request-btn pending-request';
             button.innerHTML = '<i class="fas fa-clock me-1"></i> في الانتظار';
             button.disabled = true;
             break;
         case 'accept':
             button.className = 'btn friend-request-btn accept-request';
             button.innerHTML = '<i class="fas fa-user-plus me-1"></i> قبول الطلب';
             button.onclick = () => acceptFriendRequest(userId);
             break;
         case 'friends':
             button.className = 'btn friend-request-btn btn-success';
             button.innerHTML = '<i class="fas fa-check me-1"></i> صديق';
             button.disabled = true;
             break;
         default:
             button.className = 'btn friend-request-btn send-request';
             button.innerHTML = '<i class="fas fa-user-plus me-1"></i> إضافة';
             button.onclick = () => sendFriendRequest(userId);
     }
 }
 
 // تحديث دالة تحميل المستخدمين
 async function loadUsers() {
     try {
         const usersList = document.getElementById('users-list');
         usersList.innerHTML = '';
 
         const [usersSnapshot, friendsSnapshot, requestsSnapshot] = await Promise.all([
             database.ref('users').once('value'),
             database.ref(`friends/${currentUser.uid}`).once('value'),
             database.ref(`friendRequests/${currentUser.uid}`).once('value')
         ]);
 
         const users = usersSnapshot.val();
         const friends = friendsSnapshot.val() || {};
         const requests = requestsSnapshot.val() || {};
 
         if (!users) {
             usersList.innerHTML = '<div class="p-3 text-center">لا يوجد مستخدمين حالياً</div>';
             return;
         }
 
         // عداد طلبات الإضافة
         const pendingRequests = Object.keys(requests).length;
         if (pendingRequests > 0) {
             const badge = document.createElement('div');
             badge.className = 'request-badge';
             badge.textContent = pendingRequests;
             document.body.appendChild(badge);
         }
 
         for (const [uid, userData] of Object.entries(users)) {
             if (uid === currentUser.uid) continue;
 
             const userElement = document.createElement('div');
             userElement.className = 'user-list-item';
             
             let buttonHtml = '';
             if (friends[uid]) {
                 buttonHtml = `<button class="btn friend-request-btn btn-success" disabled>
                     <i class="fas fa-check me-1"></i> صديق
                 </button>`;
             } else if (requests[uid]) {
                 buttonHtml = `<button class="btn friend-request-btn accept-request" data-user-id="${uid}"
                     onclick="acceptFriendRequest('${uid}')">
                     <i class="fas fa-user-plus me-1"></i> قبول الطلب
                 </button>`;
             } else {
                 buttonHtml = `<button class="btn friend-request-btn send-request" data-user-id="${uid}"
                     onclick="sendFriendRequest('${uid}')">
                     <i class="fas fa-user-plus me-1"></i> إضافة
                 </button>`;
             }
 
             userElement.innerHTML = `
                 <div class="d-flex align-items-center justify-content-between w-100">
                     <div class="d-flex align-items-center" onclick="startChatIfFriends('${uid}', ${!!friends[uid]})">
                         <img src="${userData.avatarUrl || '/api/placeholder/45/45'}" alt="" class="user-avatar">
                         <div class="user-info">
                             <h6 class="mb-0">${userData.username}</h6>
                             <small class="user-id">المعرف: ${userData.userId}</small>
                         </div>
                     </div>
                     ${buttonHtml}
                 </div>
             `;
 
             usersList.appendChild(userElement);
         }
     } catch (error) {
         console.error('خطأ في تحميل المستخدمين:', error);
         alert('حدث خطأ في تحميل قائمة المستخدمين');
     }
 }
 
 // تحديث دالة بدء المحادثة للتحقق من الصداقة
 function startChatIfFriends(uid, isFriend) {
     if (!isFriend) {
         alert('يجب أن تكونوا أصدقاء للتمكن من المحادثة');
         return;
     }
     
     const userData = users[uid];
     startChat(uid, userData);
 }
 
 // الاستماع لطلبات الإضافة الجديدة
 function listenToFriendRequests() {
     database.ref(`friendRequests/${currentUser.uid}`).on('child_added', (snapshot) => {
         const request = snapshot.val();
         if (request.status === 'pending') {
             // تحديث واجهة المستخدم لعرض الطلب الجديد
             loadUsers();
         }
     });
 }
 
 // إضافة المراقب عند تسجيل الدخول
 auth.onAuthStateChanged(async (user) => {
     if (user) {
         // ... الكود السابق ...
         listenToFriendRequests();
     }
 });
 
 // إضافة أنماط إضافية لقائمة طلبات الصداقة
 const notificationStyles = `
     .requests-notification {
         position: fixed;
         top: 20px;
         left: 20px;
         background: white;
         border-radius: 50px;
         padding: 8px 15px;
         display: flex;
         align-items: center;
         gap: 8px;
         box-shadow: 0 2px 10px rgba(0,0,0,0.1);
         cursor: pointer;
         z-index: 1000;
         transition: all 0.3s ease;
     }
 
     .requests-notification:hover {
         transform: translateY(-2px);
         box-shadow: 0 4px 15px rgba(0,0,0,0.2);
     }
 
     .requests-count {
         background: #ff4444;
         color: white;
         padding: 2px 8px;
         border-radius: 50px;
         font-size: 12px;
     }
 
     .requests-panel {
         position: fixed;
         top: 70px;
         left: 20px;
         background: white;
         border-radius: 15px;
         box-shadow: 0 4px 20px rgba(0,0,0,0.15);
         width: 300px;
         max-height: 400px;
         overflow-y: auto;
         z-index: 1000;
         display: none;
     }
 
     .request-item {
         padding: 15px;
         border-bottom: 1px solid #eee;
         display: flex;
         align-items: center;
         justify-content: space-between;
     }
 
     .request-user-info {
         display: flex;
         align-items: center;
         gap: 10px;
     }
 
     .request-buttons {
         display: flex;
         gap: 5px;
     }
 
     .btn-accept {
         background: var(--primary-color);
         color: white;
         padding: 5px 10px;
         border-radius: 20px;
         border: none;
         font-size: 0.8rem;
     }
 
     .btn-reject {
         background: #ff4444;
         color: white;
         padding: 5px 10px;
         border-radius: 20px;
         border: none;
         font-size: 0.8rem;
     }
 `;
 
 document.head.appendChild(document.createElement('style')).textContent = notificationStyles;
 
 // تحديث دالة بدء المحادثة
 async function startChatIfFriends(uid, isFriend) {
     try {
         // التحقق من حالة الصداقة
         const friendshipStatus = await checkFriendshipStatus(uid);
         
         if (friendshipStatus !== 'friends') {
             alert('يجب أن تكونوا أصدقاء للتمكن من المحادثة');
             return;
         }
         
         // جلب معلومات المستخدم
         const userSnapshot = await database.ref(`users/${uid}`).once('value');
         const userData = userSnapshot.val();
         
         if (userData) {
             startChat(uid, userData);
         } else {
             alert('لا يمكن العثور على معلومات المستخدم');
         }
     } catch (error) {
         console.error('خطأ في بدء المحادثة:', error);
         alert('حدث خطأ في بدء المحادثة');
     }
 }
 
 // إضافة واجهة طلبات الصداقة
 function showFriendRequests() {
     const existingPanel = document.querySelector('.requests-panel');
     if (existingPanel) {
         existingPanel.style.display = existingPanel.style.display === 'none' ? 'block' : 'none';
         return;
     }
 
     const panel = document.createElement('div');
     panel.className = 'requests-panel';
     document.body.appendChild(panel);
     
     loadFriendRequests().then(requests => {
         if (requests.length === 0) {
             panel.innerHTML = '<div class="p-3 text-center">لا توجد طلبات صداقة</div>';
             return;
         }
 
         requests.forEach(request => {
             const requestElement = document.createElement('div');
             requestElement.className = 'request-item';
             requestElement.innerHTML = `
                 <div class="request-user-info">
                     <img src="${request.senderAvatar}" class="user-avatar" style="width: 40px; height: 40px;">
                     <div>
                         <div class="fw-bold">${request.senderName}</div>
                         <small class="text-muted">يريد إضافتك كصديق</small>
                     </div>
                 </div>
                 <div class="request-buttons">
                     <button class="btn-accept" onclick="acceptFriendRequest('${request.senderId}')">
                         <i class="fas fa-check"></i>
                     </button>
                     <button class="btn-reject" onclick="rejectFriendRequest('${request.senderId}')">
                         <i class="fas fa-times"></i>
                     </button>
                 </div>
             `;
             panel.appendChild(requestElement);
         });
     });
 
     panel.style.display = 'block';
 }
 
 // تحديث دالة تحميل المستخدمين
 async function loadUsers() {
     try {
         const usersList = document.getElementById('users-list');
         usersList.innerHTML = '';
 
         const [usersSnapshot, friendsSnapshot, requestsSnapshot] = await Promise.all([
             database.ref('users').once('value'),
             database.ref(`friends/${currentUser.uid}`).once('value'),
             database.ref(`friendRequests/${currentUser.uid}`).once('value')
         ]);
 
         const users = usersSnapshot.val();
         const friends = friendsSnapshot.val() || {};
         const requests = requestsSnapshot.val() || {};
 
         // إضافة زر إشعارات طلبات الصداقة
         const pendingRequests = Object.values(requests).filter(req => req.status === 'pending').length;
         if (pendingRequests > 0) {
             const existingNotification = document.querySelector('.requests-notification');
             if (!existingNotification) {
                 const notification = document.createElement('div');
                 notification.className = 'requests-notification';
                 notification.innerHTML = `
                     <i class="fas fa-user-plus"></i>
                     <span class="requests-count">${pendingRequests}</span>
                     <span>طلبات الصداقة</span>
                 `;
                 notification.onclick = showFriendRequests;
                 document.body.appendChild(notification);
             }
         }
 
         // عرض المستخدمين
         if (!users) {
             usersList.innerHTML = '<div class="p-3 text-center">لا يوجد مستخدمين حالياً</div>';
             return;
         }
 
         // إضافة المستخدمين للقائمة
         for (const [uid, userData] of Object.entries(users)) {
             if (uid === currentUser.uid) continue;
 
             const userElement = document.createElement('div');
             userElement.className = 'user-list-item';
             
             let buttonHtml = '';
             if (friends[uid]) {
                 buttonHtml = `
                     <button class="btn friend-request-btn btn-success" onclick="startChatIfFriends('${uid}', true)">
                         <i class="fas fa-comments me-1"></i> محادثة
                     </button>`;
             } else if (requests[uid]) {
                 buttonHtml = `
                     <button class="btn friend-request-btn accept-request" data-user-id="${uid}"
                         onclick="acceptFriendRequest('${uid}')">
                         <i class="fas fa-user-plus me-1"></i> قبول الطلب
                     </button>`;
             } else {
                 buttonHtml = `
                     <button class="btn friend-request-btn send-request" data-user-id="${uid}"
                         onclick="sendFriendRequest('${uid}')">
                         <i class="fas fa-user-plus me-1"></i> إضافة
                     </button>`;
             }
 
             userElement.innerHTML = `
                 <div class="d-flex align-items-center justify-content-between w-100">
                     <div class="d-flex align-items-center">
                         <img src="${userData.avatarUrl || '/api/placeholder/45/45'}" alt="" class="user-avatar">
                         <div class="user-info">
                             <h6 class="mb-0">${userData.username}</h6>
                             <small class="user-id">المعرف: ${userData.userId}</small>
                         </div>
                     </div>
                     ${buttonHtml}
                 </div>
             `;
 
             usersList.appendChild(userElement);
         }
     } catch (error) {
         console.error('خطأ في تحميل المستخدمين:', error);
         alert('حدث خطأ في تحميل قائمة المستخدمين');
     }
 }
 // إضافة الأنماط للقائمة المنسدلة
 const userMenuStyles = `
     .user-menu-button {
         background: transparent;
         border: none;
         color: white;
         width: 40px;
         height: 40px;
         border-radius: 50%;
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: 1.2rem;
         cursor: pointer;
         transition: all 0.3s ease;
         position: relative;
     }
 
     .user-menu-button:hover {
         background: rgba(255, 255, 255, 0.1);
     }
 
     .user-menu-dropdown {
         position: absolute;
         top: 60px;
         left: 20px;
         background: white;
         border-radius: 15px;
         box-shadow: 0 4px 20px rgba(0,0,0,0.15);
         width: 250px;
         padding: 10px 0;
         display: none;
         z-index: 1000;
         animation: slideDown 0.3s ease;
     }
 
     @keyframes slideDown {
         from {
             opacity: 0;
             transform: translateY(-10px);
         }
         to {
             opacity: 1;
             transform: translateY(0);
         }
     }
 
     .user-menu-header {
         padding: 15px;
         border-bottom: 1px solid #eee;
     }
 
     .user-menu-item {
         padding: 12px 20px;
         display: flex;
         align-items: center;
         gap: 12px;
         cursor: pointer;
         transition: all 0.2s ease;
         color: var(--dark-color);
         text-decoration: none;
     }
 
     .user-menu-item:hover {
         background: rgba(124, 77, 255, 0.1);
         color: var(--primary-color);
     }
 
     .user-menu-item i {
         width: 20px;
         text-align: center;
         font-size: 1.1rem;
     }
 
     .notification-badge {
         position: absolute;
         top: -5px;
         right: -5px;
         background: #ff4444;
         color: white;
         border-radius: 50%;
         width: 20px;
         height: 20px;
         font-size: 12px;
         display: flex;
         align-items: center;
         justify-content: center;
     }
 
     .divider {
         height: 1px;
         background: #eee;
         margin: 8px 0;
     }
 `;
 
 document.head.appendChild(document.createElement('style')).textContent = userMenuStyles;
 
 // دالة تحديث رأس الصفحة وإضافة زر القائمة
 function updateHeader() {
     const header = document.querySelector('.chat-header .d-flex.justify-content-between');
     if (!header) return;
 
     // إضافة زر القائمة
     const menuButton = document.createElement('button');
     menuButton.className = 'user-menu-button';
     menuButton.innerHTML = '<i class="fas fa-ellipsis-v"></i>';
     menuButton.onclick = toggleUserMenu;
 
     // تحديث رأس الصفحة
     header.lastElementChild.appendChild(menuButton);
 
     // إضافة القائمة المنسدلة
     const dropdown = document.createElement('div');
     dropdown.className = 'user-menu-dropdown';
     dropdown.innerHTML = `
         <div class="user-menu-header">
             <div class="d-flex align-items-center gap-3">
                 <img src="${currentUser?.avatarUrl || '/api/placeholder/45/45'}" alt="" class="user-avatar" style="width: 40px; height: 40px;">
                 <div>
                     <div class="fw-bold">${currentUser?.username || 'المستخدم'}</div>
                     <small class="text-muted">${currentUser?.email || ''}</small>
                 </div>
             </div>
         </div>
         <div class="user-menu-item" onclick="showUsersList()">
             <i class="fas fa-home"></i>
             الصفحة الرئيسية
         </div>
         <div class="user-menu-item" onclick="showFriendRequests()">
             <i class="fas fa-user-plus"></i>
             طلبات الصداقة
             <span class="notification-badge" id="requests-count" style="display: none">0</span>
         </div>
         <div class="user-menu-item" onclick="showAddAccount()">
             <i class="fas fa-user-circle"></i>
             إضافة حساب آخر
         </div>
         <div class="divider"></div>
         <div class="user-menu-item" onclick="logout()">
             <i class="fas fa-sign-out-alt"></i>
             تسجيل الخروج
         </div>
     `;
     document.body.appendChild(dropdown);
 }
 
 // دالة إظهار/إخفاء القائمة
 function toggleUserMenu() {
     const dropdown = document.querySelector('.user-menu-dropdown');
     if (dropdown) {
         dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
     }
 
     // تحديث عدد طلبات الصداقة
     updateFriendRequestCount();
 }
 
 // دالة تحديث عدد طلبات الصداقة
 async function updateFriendRequestCount() {
     const requests = await loadFriendRequests();
     const badge = document.getElementById('requests-count');
     if (badge) {
         const count = requests.length;
         badge.textContent = count;
         badge.style.display = count > 0 ? 'flex' : 'none';
     }
 }
 
 // دالة إظهار نافذة إضافة حساب
 function showAddAccount() {
     // حفظ الحساب الحالي
     const currentAccount = {
         uid: currentUser.uid,
         username: currentUser.username,
         email: currentUser.email,
         avatarUrl: currentUser.avatarUrl
     };
 
     // تنظيف البيانات الحالية
     currentUser = null;
 
     // إظهار نموذج تسجيل الدخول
     document.getElementById('auth-container').style.display = 'block';
     document.getElementById('users-container').style.display = 'none';
     document.getElementById('chat-container').style.display = 'none';
     
     // إضافة زر العودة للحساب السابق
     const loginForm = document.getElementById('login-form');
     const backButton = document.createElement('button');
     backButton.className = 'btn btn-outline w-100 mt-3';
     backButton.innerHTML = '<i class="fas fa-arrow-right me-2"></i> العودة للحساب السابق';
     backButton.onclick = () => {
         currentUser = currentAccount;
         showUsersList();
     };
     loginForm.appendChild(backButton);
 }
 
 // تحديث دالة تهيئة واجهة المستخدم
 function initializeUI() {
     updateHeader();
     updateFriendRequestCount();
 
     // إغلاق القائمة عند النقر خارجها
     document.addEventListener('click', (event) => {
         const dropdown = document.querySelector('.user-menu-dropdown');
         const menuButton = document.querySelector('.user-menu-button');
         if (dropdown && menuButton && 
             !dropdown.contains(event.target) && 
             !menuButton.contains(event.target)) {
             dropdown.style.display = 'none';
         }
     });
 }
 
 // تحديث دالة عرض قائمة المستخدمين
 function showUsersList() {
     document.getElementById('auth-container').style.display = 'none';
     document.getElementById('chat-container').style.display = 'none';
     document.getElementById('users-container').style.display = 'block';
     document.getElementById('current-user-name').textContent = currentUser.username;
     document.getElementById('current-user-id').textContent = `المعرف: ${currentUser.userId}`;
     document.getElementById('current-user-avatar').src = currentUser.avatarUrl;
     
     // تحديث واجهة المستخدم
     updateHeader();
     loadUsers();
 }
 
 // تحديث مراقب حالة المصادقة
 auth.onAuthStateChanged(async (user) => {
     if (user) {
         const snapshot = await database.ref(`users/${user.uid}`).once('value');
         const userData = snapshot.val();
         
         currentUser = {
             uid: user.uid,
             username: userData.username,
             userId: userData.userId,
             email: user.email,
             avatarUrl: userData.avatarUrl || '/api/placeholder/45/45'
         };
         
         showUsersList();
         initializeUI();
     } else {
         document.getElementById('chat-container').style.display = 'none';
         document.getElementById('users-container').style.display = 'none';
         document.getElementById('auth-container').style.display = 'block';
         showLogin();
     }
 });
 
 
 if ('serviceWorker' in navigator) {
     window.addEventListener('load', () => {
         navigator.serviceWorker.register('/service-worker.js')
             .then(registration => {
                 console.log('ServiceWorker registration successful');
             })
             .catch(error => {
                 console.log('ServiceWorker registration failed:', error);
             });
     });
 }
 
 // تحديث دالة toggleUserMenu لتعمل في كلا الواجهتين
 function toggleUserMenu(event) {
     event.preventDefault();
     event.stopPropagation();
     
     // تحديد القائمة المنسدلة القريبة من الزر الذي تم النقر عليه
     const button = event.currentTarget;
     const dropdown = button.nextElementSibling;
     const isVisible = dropdown.style.display === 'block';
     
     // إغلاق جميع القوائم المنسدلة المفتوحة
     document.querySelectorAll('.menu-dropdown').forEach(menu => {
         menu.style.display = 'none';
     });
     
     if (isVisible) {
         dropdown.style.display = 'none';
         return;
     }
     
     // تحديث معلومات المستخدم في القائمة
     const username = dropdown.querySelector('.menu-username');
     const email = dropdown.querySelector('.menu-email');
     const avatar = dropdown.querySelector('.menu-avatar');
     
     if (currentUser) {
         username.textContent = currentUser.username;
         email.textContent = currentUser.email;
         avatar.src = currentUser.avatarUrl;
     }
     
     dropdown.style.display = 'block';
     updateFriendRequestCount();
     
     // تحديد موقع القائمة المنسدلة
     const rect = button.getBoundingClientRect();
     dropdown.style.top = `${rect.bottom + 5}px`;
     dropdown.style.right = `${window.innerWidth - rect.right}px`;
 }
 
 // تحديث مستمع النقر خارج القوائم
 document.addEventListener('click', (event) => {
     const dropdowns = document.querySelectorAll('.menu-dropdown');
     const triggers = document.querySelectorAll('.menu-trigger');
     
     let clickedOnTrigger = false;
     triggers.forEach(trigger => {
         if (trigger.contains(event.target)) {
             clickedOnTrigger = true;
         }
     });
     
     if (!clickedOnTrigger) {
         dropdowns.forEach(dropdown => {
             if (!dropdown.contains(event.target)) {
                 dropdown.style.display = 'none';
             }
         });
     }
 });
 
 // تحديث دالة معالجة النقر على عناصر القائمة
 function handleMenuClick(action, event) {
     event.preventDefault();
     event.stopPropagation();
     
     // إغلاق جميع القوائم المنسدلة
     document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
         dropdown.style.display = 'none';
     });
     
     switch (action) {
         case 'home':
             showUsersList();
             break;
         case 'requests':
             showFriendRequests();
             break;
         case 'account':
             showAddAccount();
             break;
         case 'logout':
             if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                 logout();
             }
             break;
     }
 }
 
 // إضافة أنماط CSS إضافية للقوائم المنسدلة
 const additionalStyles = `
     .menu-dropdown {
         position: fixed;
         background: white;
         border-radius: 12px;
         box-shadow: 0 4px 20px rgba(0,0,0,0.15);
         width: 280px;
         z-index: 1000;
         animation: slideDown 0.2s ease;
     }
 
     .menu-trigger {
         background: transparent;
         border: none;
         color: white;
         width: 40px;
         height: 40px;
         border-radius: 50%;
         display: flex;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         transition: background-color 0.3s ease;
     }
 
     .menu-trigger:hover {
         background-color: rgba(255, 255, 255, 0.1);
     }
 `;
 
 // إضافة الأنماط الجديدة إلى الصفحة
 const styleSheet = document.createElement('style');
 styleSheet.textContent = additionalStyles;
 document.head.appendChild(styleSheet);
 
 // دالة معالجة النقر على عناصر القائمة
 function handleMenuClick(action, event) {
     event.preventDefault();
     event.stopPropagation();
     
     const dropdown = document.querySelector('.menu-dropdown');
     
     switch (action) {
         case 'home':
             showUsersList();
             break;
         case 'requests':
             showFriendRequests();
             break;
         case 'account':
             showAddAccount();
             break;
         case 'logout':
             if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                 logout();
             }
             break;
     }
     
     // إغلاق القائمة بعد اختيار عنصر
     dropdown.style.display = 'none';
 }
 
 // إضافة مستمع لإغلاق القائمة عند النقر خارجها
 document.addEventListener('click', (event) => {
     const dropdown = document.querySelector('.menu-dropdown');
     const trigger = document.querySelector('.menu-trigger');
     
     if (!dropdown || !trigger) return;
     
     if (!dropdown.contains(event.target) && !trigger.contains(event.target)) {
         dropdown.style.display = 'none';
     }
 });
 
 // تحديث عدد طلبات الصداقة
 async function updateFriendRequestCount() {
     const badge = document.getElementById('requests-badge');
     if (!badge) return;
     
     try {
         const requests = await loadFriendRequests();
         const count = requests.length;
         
         badge.textContent = count;
         badge.style.display = count > 0 ? 'inline-block' : 'none';
     } catch (error) {
         console.error('خطأ في تحديث عدد طلبات الصداقة:', error);
     }
 }
 
 // تأكد من إضافة المستمعات عند تحميل الصفحة
 document.addEventListener('DOMContentLoaded', () => {
     initializeUI();
 });
 
 // دالة تهيئة واجهة المستخدم
 function initializeUI() {
     updateFriendRequestCount();
 }
 
 // دالة معالجة رفع الملفات
 async function handleFileUpload(event, type) {
     const file = event.target.files[0];
     if (!file) return;
 
     try {
      
 
         // رفع الملف إلى Firebase Storage
         const storageRef = storage.ref();
         const fileRef = storageRef.child(`chats/${currentUser.uid}/${Date.now()}_${file.name}`);
         await fileRef.put(file);
         const fileUrl = await fileRef.getDownloadURL();
 
         // إرسال الرسالة مع الملف
         const chatId = getChatId(currentUser.uid, currentChatUser.uid);
         await database.ref(`chats/${chatId}/messages`).push({
             senderId: currentUser.uid,
             senderName: currentUser.username,
             type: type,
             fileUrl: fileUrl,
             fileName: file.name,
             fileSize: file.size,
             timestamp: firebase.database.ServerValue.TIMESTAMP
         });
 
         // إغلاق مؤشر التحميل
         Swal.close();
     } catch (error) {
         console.error('خطأ في رفع الملف:', error);
         Swal.fire({
             icon: 'error',
             title: 'خطأ في رفع الملف',
             text: error.message
         });
     }
 
     // تفريغ حقل الملف
     event.target.value = '';
 }
 
 // تحديث دالة عرض الرسائل
 
 
 // دالة عرض الوسائط في حجم كامل
 function showMediaPreview(url, type) {
     if (type === 'image') {
         Swal.fire({
             imageUrl: url,
             showCloseButton: true,
             showConfirmButton: false,
             customClass: {
                 container: 'media-preview-container',
                 image: 'media-preview-image'
             },
             background: 'rgba(0,0,0,0.9)',
             width: '100%',
             padding: 0,
             heightAuto: false,
             click: (e) => {
                 if (e.target.classList.contains('swal2-container')) {
                     Swal.close();
                 }
             }
         });
     }
 }
 
 // دالة تنسيق الوقت
 function formatMessageTime(timestamp) {
     const date = new Date(timestamp);
     const now = new Date();
     const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
     
     if (diffDays === 0) {
         return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
     } else if (diffDays === 1) {
         return 'أمس';
     } else {
         return date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
     }
 }
 // دالة تنسيق حجم الملف
 function formatFileSize(bytes) {
     if (bytes === 0) return '0 Bytes';
     const k = 1024;
     const sizes = ['Bytes', 'KB', 'MB', 'GB'];
     const i = Math.floor(Math.log(bytes) / Math.log(k));
     return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
 }
     // ...existing code...
     
     // تحديث دالة معالجة اختيار الملفات
 function handleFileSelection(event, type) {
     const files = Array.from(event.target.files);
     
     files.forEach(file => {
         if (type === 'image') {
             // إظهار معاينة الصورة مباشرة في خانة الدردشة
             const reader = new FileReader();
             reader.onload = (e) => {
                 const preview = document.createElement('div');
                 preview.className = 'selected-file-preview';
                 preview.dataset.type = type;
                 preview.dataset.file = JSON.stringify(file);
                 preview.innerHTML = `
                     <div class="preview-inner">
                         <img src="${e.target.result}" alt="${file.name}">
                         <button type="button" class="remove-preview" onclick="removeSelectedFile(this)">
                             <i class="fas fa-times"></i>
                         </button>
                     </div>
                 `;
                 document.querySelector('.input-wrapper').insertBefore(preview, document.querySelector('.message-input'));
             };
             reader.readAsDataURL(file);
         } else if (type === 'audio') {
             // إظهار معاينة الملف الصوتي
             const preview = document.createElement('div');
             preview.className = 'selected-file-preview';
             preview.dataset.type = type;
             preview.dataset.file = JSON.stringify(file);
             preview.innerHTML = `
                 <div class="preview-inner">
                     <div class="audio-preview">
                         <i class="fas fa-music"></i>
                         <span>${file.name}</span>
                     </div>
                     <button type="button" class="remove-preview" onclick="removeSelectedFile(this)">
                         <i class="fas fa-times"></i>
                     </button>
                 </div>
             `;
             document.querySelector('.input-wrapper').insertBefore(preview, document.querySelector('.message-input'));
         } else {
             // إظهار معاينة الملفات الأخرى
             const preview = document.createElement('div');
             preview.className = 'selected-file-preview';
             preview.dataset.type = type;
             preview.dataset.file = JSON.stringify(file);
             preview.innerHTML = `
                 <div class="preview-inner">
                     <div class="file-preview">
                         <i class="fas fa-file"></i>
                         <span>${file.name}</span>
                     </div>
                     <button type="button" class="remove-preview" onclick="removeSelectedFile(this)">
                         <i class="fas fa-times"></i>
                     </button>
                 </div>
             `;
             document.querySelector('.input-wrapper').insertBefore(preview, document.querySelector('.message-input'));
         }
     });
 }
 
 // دالة حذف الملف المحدد
 function removeSelectedFile(button) {
     button.closest('.selected-file-preview').remove();
 }
 
 // تحديث دالة إرسال الرسالة
 async function sendMessage(event) {
     event.preventDefault();
     const messageInput = document.getElementById('message-input');
     const message = messageInput.value.trim();
     const selectedFiles = Array.from(document.querySelectorAll('.selected-file-preview'));
     
     if (!message && selectedFiles.length === 0) return;
     
     try {
         const chatId = getChatId(currentUser.uid, currentChatUser.uid);
         const messageData = {
             senderId: currentUser.uid,
             senderName: currentUser.username,
             message: message,
             timestamp: firebase.database.ServerValue.TIMESTAMP,
             attachments: []
         };
 
         // رفع الملفات المرفقة
         for (const filePreview of selectedFiles) {
             const file = JSON.parse(filePreview.dataset.file);
             const type = filePreview.dataset.type;
             const fileRef = storage.ref(`chats/${currentUser.uid}/${Date.now()}_${file.name}`);
             
             if (type === 'image') {
                 const dataUrl = filePreview.querySelector('img').src;
                 const response = await fetch(dataUrl);
                 const blob = await response.blob();
                 await fileRef.put(blob);
                 const url = await fileRef.getDownloadURL();
                 messageData.attachments.push({
                     type: 'image',
                     url: url,
                     name: file.name
                 });
             } else {
                 const blob = new Blob([file], { type: file.type });
                 await fileRef.put(blob);
                 const url = await fileRef.getDownloadURL();
                 messageData.attachments.push({
                     type: type,
                     url: url,
                     name: file.name,
                     size: file.size
                 });
             }
         }
 
         // إرسال الرسالة
         await database.ref(`chats/${chatId}/messages`).push(messageData);
         
         // تنظيف الحقول
         messageInput.value = '';
         selectedFiles.forEach(preview => preview.remove());
         
     } catch (error) {
         console.error('خطأ في إرسال الرسالة:', error);
         alert('حدث خطأ في إرسال الرسالة');
     }
 }
 
 // تحديث دالة معالجة اختيار الملفات
 async function handleFileSelection(event, type) {
     const files = Array.from(event.target.files);
     const previewArea = document.getElementById('file-preview-area');
     const container = document.getElementById('selected-files-container');
     
     if (files.length === 0) return;
     
     previewArea.style.display = 'block';
     
     for (const file of files) {
         const preview = document.createElement('div');
         preview.className = 'selected-file-preview';
         preview.dataset.type = type;
         preview.file = file;
         
         // إنشاء عناصر المعاينة والمؤشر
         const content = await createPreviewContent(file, type);
         const uploadOverlay = createUploadOverlay();
         
         preview.innerHTML = `
             <div class="preview-inner">
                 ${content}
                 ${uploadOverlay}
                 <button class="remove-preview" onclick="removeSelectedFile(this)">×</button>
             </div>
         `;
         
         container.appendChild(preview);
     }
 }
 
 // دالة إنشاء محتوى المعاينة
 async function createPreviewContent(file, type) {
     switch(type) {
         case 'image':
             const imageUrl = await readFileAsDataURL(file);
             return `
                 <img src="${imageUrl}" alt="${file.name}">
                 <div class="file-name">${file.name}</div>
             `;
             
         case 'audio':
             return `
                 <div class="audio-preview">
                     <i class="fas fa-music"></i>
                     <div class="file-name">${file.name}</div>
                 </div>
             `;
             
         default:
             return `
                 <div class="file-preview">
                     <i class="fas fa-file"></i>
                     <div class="file-name">${file.name}</div>
                 </div>
             `;
     }
 }
 
 // دالة إنشاء مؤشر التحميل
 function createUploadOverlay() {
     return `
         <div class="upload-overlay" style="display:none;">
             <div class="spinner-wrapper">
                 <div class="upload-spinner"></div>
                 <i class="fas fa-check success-icon"></i>
             </div>
             <div class="upload-progress">0%</div>
         </div>
     `;
 }
 
 // تحديث دالة إرسال الرسالة
 async function sendMessage(event) {
     event.preventDefault();
     const messageInput = document.getElementById('message-input');
     const message = messageInput.value.trim();
     const selectedFiles = Array.from(document.querySelectorAll('.selected-file-preview'));
     
     if (!message && selectedFiles.length === 0) return;
     
     const chatId = getChatId(currentUser.uid, currentChatUser.uid);
     const messageData = {
         senderId: currentUser.uid,
         senderName: currentUser.username,
         message: message,
         timestamp: firebase.database.ServerValue.TIMESTAMP,
         attachments: []
     };
 
     // إرسال الرسالة النصية أولاً
     const messageRef = await database.ref(`chats/${chatId}/messages`).push(messageData);
 
     // رفع الملفات المرفقة
     if (selectedFiles.length > 0) {
         for (const preview of selectedFiles) {
             const file = preview.file;
             const type = preview.dataset.type;
             const overlay = preview.querySelector('.upload-overlay');
             const progressText = overlay.querySelector('.upload-progress');
             const spinner = overlay.querySelector('.spinner-wrapper');
             
             overlay.style.display = 'flex';
             
             try {
                 const fileRef = storage.ref(`chats/${chatId}/${Date.now()}_${file.name}`);
                 
                 // رفع الملف مع متابعة التقدم
                 const uploadTask = fileRef.put(file);
                 
                 uploadTask.on('state_changed', 
                     (snapshot) => {
                         const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                         progressText.textContent = `${progress}%`;
                     },
                     (error) => {
                         console.error('خطأ في رفع الملف:', error);
                         overlay.style.backgroundColor = 'rgba(255,0,0,0.6)';
                         progressText.textContent = 'فشل الرفع';
                     },
                     async () => {
                         const url = await uploadTask.snapshot.ref.getDownloadURL();
                         
                         // إضافة معلومات الملف إلى المرفقات
                         messageData.attachments.push({
                             type: type,
                             url: url,
                             name: file.name,
                             size: file.size
                         });
                         
                         // تحديث الرسالة مع المرفق الجديد
                         await database.ref(`chats/${chatId}/messages/${messageRef.key}`).update({
                             attachments: messageData.attachments
                         });
                         
                         // إظهار علامة النجاح
                         overlay.classList.add('upload-complete');
                         spinner.innerHTML = '<i class="fas fa-check success-icon"></i>';
                         progressText.textContent = 'تم الرفع';
                         
                         setTimeout(() => {
                             preview.remove();
                             if (document.querySelectorAll('.selected-file-preview').length === 0) {
                                 document.getElementById('file-preview-area').style.display = 'none';
                             }
                         }, 1000);
                     }
                 );
             } catch (error) {
                 console.error('خطأ في رفع الملف:', error);
             }
         }
     }
     
     // تنظيف حقل الرسالة
     messageInput.value = '';
 }
 
 // دالة مساعدة لقراءة الملف كـ DataURL
 function readFileAsDataURL(file) {
     return new Promise((resolve) => {
         const reader = new FileReader();
         reader.onload = (e) => resolve(e.target.result);
         reader.readAsDataURL(file);
     });
 }
 
 // تحديث دالة عرض الرسائل
 
 
 // دالة إزالة الملف
 function removeSelectedFile(button) {
     const preview = button.closest('.selected-file-preview');
     const container = preview.parentElement;
     preview.remove();
     
     // إخفاء منطقة المعاينة إذا لم تعد هناك ملفات
     if (container.children.length === 0) {
         document.getElementById('file-preview-area').style.display = 'none';
     }
     
     // تعديل حجم حقل الإدخال
     adjustInputHeight();
 }
 
 // دالة تعديل حجم حقل الإدخال
 function adjustInputHeight() {
     const previewArea = document.getElementById('file-preview-area');
     const messageInput = document.getElementById('message-input');
     
     if (previewArea.style.display === 'none') {
         messageInput.style.height = 'auto';
     } else {
         messageInput.style.height = '40px';
     }
 }
 
 // دالة مساعدة لتحويل الملف إلى Base64
 function readFileAsBase64(file) {
     return new Promise((resolve, reject) => {
         const reader = new FileReader();
         reader.onload = (e) => resolve(e.target.result);
         reader.onerror = (e) => reject(e);
         reader.readAsDataURL(file);
     });
 }
 
 // دالة إزالة الملف المحدد
 function removeSelectedFile(button) {
     button.closest('.selected-file-preview').remove();
     if (document.querySelectorAll('.selected-file-preview').length === 0) {
         document.getElementById('file-preview-area').style.display = 'none';
     }
 }
 
 // دالة تنظيف جميع الملفات المحددة
 function clearSelectedFiles() {
     document.querySelectorAll('.selected-file-preview').forEach(preview => preview.remove());
     document.getElementById('file-preview-area').style.display = 'none';
 }
 
 // تحديث دالة إرسال الرسالة
 async function sendMessage(event) {
     event.preventDefault();
     const messageInput = document.getElementById('message-input');
     const message = messageInput.value.trim();
     const selectedFiles = Array.from(document.querySelectorAll('.selected-file-preview'));
     
     if (!message && selectedFiles.length === 0) return;
     
     try {
        
 
         const chatId = getChatId(currentUser.uid, currentChatUser.uid);
         const messageData = {
             senderId: currentUser.uid,
             senderName: currentUser.username,
             message: message,
             timestamp: firebase.database.ServerValue.TIMESTAMP,
             attachments: []
         };
 
         // رفع الملفات المرفقة
         for (const filePreview of selectedFiles) {
             const file = filePreview.file;
             const type = filePreview.dataset.type;
             
             try {
                 const fileRef = storage.ref(`chats/${currentUser.uid}/${Date.now()}_${file.name}`);
                 await fileRef.put(file);
                 const url = await fileRef.getDownloadURL();
                 
                 messageData.attachments.push({
                     type: type,
                     url: url,
                     name: file.name,
                     size: file.size
                 });
             } catch (error) {
                 console.error('خطأ في رفع الملف:', error);
             }
         }
 
         // إرسال الرسالة
         await database.ref(`chats/${chatId}/messages`).push(messageData);
         
         // تنظيف الحقول
         messageInput.value = '';
         clearSelectedFiles();
         
         Swal.close();
     } catch (error) {
         console.error('خطأ في إرسال الرسالة:', error);
         Swal.fire({
             icon: 'error',
             title: 'خطأ في الإرسال',
             text: error.message
         });
     }
 }
 
 // تحديث دالة عرض الرسالة
 function displayMessage(messageData) {
     const messagesContainer = document.getElementById('messages-container');
     const messageElement = document.createElement('div');
     messageElement.classList.add('message');
     
     const isSender = messageData.senderId === currentUser.uid;
     messageElement.classList.add(isSender ? 'message-sent' : 'message-received');
 
     let messageContent = '';
 
     if (messageData.message) {
         messageContent += `<div class="message-text">${messageData.message}</div>`;
     }
 
     if (messageData.attachments && messageData.attachments.length > 0) {
         messageContent += '<div class="message-attachments">';
         messageData.attachments.forEach((attachment, index) => {
             const attachmentId = `attachment-${Date.now()}-${index}`;
             
             switch (attachment.type) {
                 case 'image':
                     messageContent += `
                         <div class="message-attachment" id="${attachmentId}-container">
                             <div class="attachment-loading" id="${attachmentId}-loading">
                                 <div class="loading-spinner"></div>
                             </div>
                             <img src="${attachment.url}" 
                                  alt="${attachment.name}" 
                                  class="message-image"
                                  onload="handleAttachmentLoaded('${attachmentId}', ${isSender})"
                                  onclick="showFullImage('${attachment.url}')">
                             ${isSender ? `
                             <div class="message-status-wrapper">
                                 <i class="fas fa-check message-status-single" id="${attachmentId}-single"></i>
                                 <i class="fas fa-check-double message-status-double" id="${attachmentId}-double"></i>
                             </div>` : ''}
                         </div>
                     `;
                     break;
                 // ... باقي الحالات كما هي ...
             }
         });
         messageContent += '</div>';
     }
 
     messageContent += `
         <div class="message-footer">
             <span class="message-time">${formatMessageTime(messageData.timestamp)}</span>
             ${isSender ? `
             <div class="message-status-wrapper">
                 <i class="fas fa-check message-status-single"></i>
                 <i class="fas fa-check-double message-status-double"></i>
             </div>` : ''}
         </div>
     `;
 
     messageElement.innerHTML = messageContent;
     messagesContainer.appendChild(messageElement);
     messagesContainer.scrollTop = messagesContainer.scrollHeight;
 
     // محاكاة المشاهدة بعد 3 ثواني (للتجربة فقط)
     if (isSender) {
         setTimeout(() => {
             messageElement.querySelectorAll('.message-status-double').forEach(status => {
                 status.classList.add('seen');
             });
         }, 3000);
     }
 }
 
 function handleAttachmentLoaded(attachmentId, isSender) {
     const container = document.getElementById(`${attachmentId}-container`);
     const loadingDiv = document.getElementById(`${attachmentId}-loading`);
     
     if (loadingDiv) {
         // إخفاء مؤشر التحميل
         loadingDiv.style.opacity = '0';
         setTimeout(() => {
             loadingDiv.remove();
         }, 300);
 
         if (isSender) {
             // إظهار علامة التأكيد الأولى
             const singleCheck = document.getElementById(`${attachmentId}-single`);
             if (singleCheck) {
                 singleCheck.style.opacity = '1';
                 
                 // بعد ثانيتين نظهر علامتي التأكيد
                 setTimeout(() => {
                     const doubleCheck = document.getElementById(`${attachmentId}-double`);
                     if (doubleCheck) {
                         singleCheck.style.opacity = '0';
                         doubleCheck.style.opacity = '1';
                         
                         // بعد ثانية نجعلها زرقاء (تمت المشاهدة)
                         setTimeout(() => {
                             doubleCheck.classList.add('seen');
                         }, 1000);
                     }
                 }, 2000);
             }
         }
     }
 }
 // دالة عرض الصورة في حجم كامل
 function showFullImage(url) {
     Swal.fire({
         imageUrl: url,
         imageAlt: 'صورة مرفقة',
         showCloseButton: true,
         showConfirmButton: false,
         width: '90%'
     });
 }
 
 // دالة تنسيق حجم الملف
 function formatFileSize(bytes) {
     if (bytes === 0) return '0 B';
     const k = 1024;
     const sizes = ['B', 'KB', 'MB', 'GB'];
     const i = Math.floor(Math.log(bytes) / Math.log(k));
     return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
 }
 
 // تحديث دالة تحميل الرسائل
 function loadMessages(chatId) {
     const messagesContainer = document.getElementById('messages-container');
     messagesContainer.innerHTML = '';
     
     // إلغاء الاستماع للمحادثات السابقة
     if (window.currentMessagesRef) {
         window.currentMessagesRef.off();
     }
     
     // الاستماع للرسائل الجديدة
     window.currentMessagesRef = database.ref(`chats/${chatId}/messages`);
     window.currentMessagesRef.on('child_added', (snapshot) => {
         const messageData = snapshot.val();
         displayMessage(messageData);
     });
 }
 
 // تحديث دالة معالجة اختيار الملفات
 
 // دالة معالجة اختيار الملفات
 
 
 // دالة إزالة الملف المحدد
 function removeSelectedFile(button) {
     const preview = button.closest('.selected-file-preview');
     const container = preview.parentElement;
     preview.remove();
     
     // إخفاء منطقة المعاينة إذا لم تعد هناك ملفات
     if (container.children.length === 0) {
         document.getElementById('file-preview-area').style.display = 'none';
     }
 }
 
 // دالة تنسيق حجم الملف
 function formatFileSize(bytes) {
     if (bytes === 0) return '0 B';
     const k = 1024;
     const sizes = ['B', 'KB', 'MB', 'GB'];
     const i = Math.floor(Math.log(bytes) / Math.log(k));
     return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
 }
 
 // دالة عرض الرسائل
 
 
 // دالة عرض الوسائط
 function showMediaPreview(url) {
     Swal.fire({
         imageUrl: url,
         showCloseButton: true,
         showConfirmButton: false,
         customClass: {
             container: 'media-preview-container',
             image: 'media-preview-image'
         },
         background: 'rgba(0,0,0,0.9)',
         width: '100%',
         padding: 0
     });
 }
 
 // دالة إزالة ملف محدد
 function removeSelectedFile(button) {
     const preview = button.closest('.file-preview');
     preview.remove();
     
     // إخفاء منطقة المعاينة إذا لم تعد هناك ملفات
     if (document.querySelectorAll('.file-preview').length === 0) {
         document.getElementById('file-preview-area').style.display = 'none';
     }
 }
 
 // إضافة مستمعي الأحداث عند تحميل الصفحة
 document.addEventListener('DOMContentLoaded', () => {
     // تعطيل السحب والإفلات الافتراضي للمتصفح
     document.addEventListener('dragover', (e) => {
         e.preventDefault();
         e.stopPropagation();
     });
     
     document.addEventListener('drop', (e) => {
         e.preventDefault();
         e.stopPropagation();
     });
     
     // تمكين السحب والإفلات في منطقة الإدخال
     const inputWrapper = document.querySelector('.input-wrapper');
     
     inputWrapper.addEventListener('dragover', (e) => {
         e.preventDefault();
         e.stopPropagation();
         inputWrapper.classList.add('drag-over');
     });
     
     inputWrapper.addEventListener('dragleave', () => {
         inputWrapper.classList.remove('drag-over');
     });
     
     inputWrapper.addEventListener('drop', (e) => {
         e.preventDefault();
         e.stopPropagation();
         inputWrapper.classList.remove('drag-over');
         
         const files = Array.from(e.dataTransfer.files);
         files.forEach(file => {
             let type = 'file';
             if (file.type.startsWith('image/')) {
                 type = 'image';
             } else if (file.type.startsWith('audio/')) {
                 type = 'audio';
             }
             
             const event = { target: { files: [file] } };
             handleFileSelection(event, type);
         });
     });
 });
 // دالة مساعدة لتحويل الملف إلى Base64
 function readFileAsBase64(file) {
     return new Promise((resolve, reject) => {
         const reader = new FileReader();
         reader.onload = (e) => resolve(e.target.result);
         reader.onerror = (e) => reject(e);
         reader.readAsDataURL(file);
     });
 }
 
 // تحديث دالة إرسال الرسالة
 async function sendMessage(event) {
     event.preventDefault();
     const messageInput = document.getElementById('message-input');
     const message = messageInput.value.trim();
     const selectedFiles = Array.from(document.querySelectorAll('.selected-file-preview'));
     
     // التحقق من وجود رسالة أو ملفات
     if (!message && selectedFiles.length === 0) return;
     
     try {
        
 
         const chatId = getChatId(currentUser.uid, currentChatUser.uid);
         const messageData = {
             senderId: currentUser.uid,
             senderName: currentUser.username,
             message: message,
             timestamp: firebase.database.ServerValue.TIMESTAMP,
             attachments: []
         };
 
         // رفع الملفات المرفقة
         if (selectedFiles.length > 0) {
             for (const filePreview of selectedFiles) {
                 const file = filePreview.file;
                 const type = filePreview.dataset.type;
                 
                 try {
                     const fileRef = storage.ref(`chats/${currentUser.uid}/${Date.now()}_${file.name}`);
                     await fileRef.put(file);
                     const url = await fileRef.getDownloadURL();
                     
                     messageData.attachments.push({
                         type: type,
                         url: url,
                         name: file.name,
                         size: file.size
                     });
                 } catch (error) {
                     console.error('خطأ في رفع الملف:', error);
                 }
             }
         }
 
         // إرسال الرسالة
         await database.ref(`chats/${chatId}/messages`).push(messageData);
         
         // تنظيف الحقول
         messageInput.value = '';
         selectedFiles.forEach(preview => preview.remove());
         
         Swal.close();
     } catch (error) {
         console.error('خطأ في إرسال الرسالة:', error);
         Swal.fire({
             icon: 'error',
             title: 'خطأ في الإرسال',
             text: error.message
         });
     }
 }
 
 // تحديث دالة عرض الرسالة لتشمل المرفقات
 // تحديث دالة displayMessage لعرض الرسائل والمرفقات في messages-container
 
 
 // دالة لعرض الصورة في وضع ملء الشاشة
 function showFullImage(url) {
     Swal.fire({
         imageUrl: url,
         imageAlt: 'صورة مرفقة',
         showCloseButton: true,
         showConfirmButton: false,
         customClass: {
             container: 'full-image-container',
             image: 'full-image'
         },
         background: 'rgba(0,0,0,0.9)',
         width: '100%',
         height: '100%',
         padding: 0
     });
 }
 // دالة عرض الصورة في حجم كامل
 function showFullImage(url) {
     Swal.fire({
         imageUrl: url,
         imageAlt: 'صورة مرفقة',
         showCloseButton: true,
         showConfirmButton: false,
         width: '90%'
     });
 }
 
 // متغيرات عامة للمكالمات
 let currentCall = null;
 let localStream = null;
 let remoteStream = null;
 let peerConnection = null;
 
 // تكوين WebRTC
 const RTCConfiguration = {
     iceServers: [
         { urls: 'stun:stun.l.google.com:19302' }
     ]
 };
 
 // إعدادات الوسائط
 const mediaConstraints = {
     audio: {
         echoCancellation: true,
         noiseSuppression: true,
         autoGainControl: true
     },
     video: {
         width: { ideal: 1280 },
         height: { ideal: 720 },
         facingMode: 'user'
     }
 };
 
 // إضافة متغيرات للمكالمة
 let callTimer = null;
 let callDuration = 0;
 let callConnection = null;
 
 // تحديث دالة setupPeerConnection
 function setupPeerConnection() {
     try {
         peerConnection = new RTCPeerConnection(RTCConfiguration);
 
         // إضافة المسارات المحلية
         if (localStream) {
             localStream.getTracks().forEach(track => {
                 peerConnection.addTrack(track, localStream);
             });
         }
 
         // معالجة الأحداث
         peerConnection.onicecandidate = event => {
             if (event.candidate && currentChatUser) {
                 database.ref(`calls/${currentChatUser.uid}/candidates`).push(event.candidate);
             }
         };
 
         peerConnection.ontrack = event => {
             remoteStream = event.streams[0];
             const remoteAudio = document.getElementById('remote-audio');
             if (remoteAudio) {
                 remoteAudio.srcObject = remoteStream;
                 remoteAudio.play().catch(console.error);
             }
             // بدء عداد المكالمة
             startCallTimer();
         };
 
         // مراقبة حالة الاتصال
         peerConnection.oniceconnectionstatechange = () => {
             if (peerConnection.iceConnectionState === 'disconnected') {
                 endCall();
             }
         };
 
     } catch (error) {
         console.error('خطأ في إعداد اتصال WebRTC:', error);
         handleCallError(error);
     }
 }
 
 // دالة بدء عداد المكالمة
 function startCallTimer() {
     const timerDisplay = document.getElementById('call-timer');
     if (!timerDisplay) return;
 
     callDuration = 0;
     callTimer = setInterval(() => {
         callDuration++;
         const minutes = Math.floor(callDuration / 60);
         const seconds = callDuration % 60;
         timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
     }, 1000);
 }
 
 // تحديث دالة إنهاء المكالمة
 async function endCall() {
     try {
         // إيقاف عداد المكالمة
         if (callTimer) {
             clearInterval(callTimer);
             callTimer = null;
         }
 
         // إيقاف الأصوات
         callAudio.stopAll();
         callSounds.callEnd.play().catch(console.error);
 
         // إيقاف المسارات المحلية
         if (localStream) {
             localStream.getTracks().forEach(track => track.stop());
             localStream = null;
         }
 
         // إغلاق اتصال WebRTC
         if (peerConnection) {
             peerConnection.close();
             peerConnection = null;
         }
 
         // إخفاء واجهة المكالمة
         const callInterface = document.getElementById('call-interface');
         const callStatus = document.getElementById('call-status');
         if (callInterface) {
             callInterface.style.display = 'none';
             if (callStatus) {
                 callStatus.textContent = 'تم إنهاء المكالمة';
             }
         }
 
         // إرسال إشعار إنهاء المكالمة
         if (currentChatUser) {
             await database.ref(`calls/${currentChatUser.uid}/status`).set({
                 type: 'ended',
                 from: currentUser.uid,
                 timestamp: Date.now(),
                 duration: callDuration
             });
             
             await database.ref(`calls/${currentChatUser.uid}/active`).remove();
         }
 
     } catch (error) {
         console.error('خطأ في إنهاء المكالمة:', error);
     }
 }
 
 // تحديث دالة handleAcceptCall
 async function handleAcceptCall(callData, type) {
     try {
         const mediaConfig = {
             audio: true,
             video: type === 'video'
         };
         
         localStream = await navigator.mediaDevices.getUserMedia(mediaConfig);
         
         // إظهار واجهة المكالمة
         showCallInterface(type);
         
         // إعداد اتصال WebRTC
         setupPeerConnection();
         
         // تحديث حالة المكالمة
         const callStatus = document.getElementById('call-status');
         if (callStatus) {
             callStatus.textContent = 'تم الاتصال';
         }
         
         // إضافة عنصر عداد المكالمة
         const timerDisplay = document.createElement('div');
         timerDisplay.id = 'call-timer';
         timerDisplay.className = 'call-timer';
         callStatus.parentNode.insertBefore(timerDisplay, callStatus.nextSibling);
         
         // بدء عداد المكالمة
         startCallTimer();
         
         // إرسال رد القبول
         await database.ref(`calls/${callData.from}/status`).set({
             type: 'answered',
             from: currentUser.uid,
             timestamp: Date.now()
         });
         
     } catch (error) {
         console.error('خطأ في قبول المكالمة:', error);
         handleCallError(error);
     }
 }
 
 // تحديث دالة handleRejectCall
 async function handleRejectCall(callData) {
     try {
         await database.ref(`calls/${callData.from}/status`).set({
             type: 'rejected',
             from: currentUser.uid,
             timestamp: Date.now()
         });
         
         // تحديث حالة المكالمة وإخفاء الواجهة
         const callStatus = document.getElementById('call-status');
         if (callStatus) {
             callStatus.textContent = 'تم رفض المكالمة';
         }
         
         setTimeout(() => {
             const callInterface = document.getElementById('call-interface');
             if (callInterface) {
                 callInterface.style.display = 'none';
             }
         }, 1500);
         
         await database.ref(`calls/${currentUser.uid}/active`).remove();
         
     } catch (error) {
         console.error('خطأ في رفض المكالمة:', error);
     }
 }
 
 // دالة عرض نافذة طلب الأذونات
 function showPermissionDialog(type) {
     return Swal.fire({
         title: 'مطلوب أذونات',
         text: type === 'camera-mic' ? 
             'يرجى السماح بالوصول إلى الكاميرا والميكروفون' :
             'يرجى السماح بالوصول إلى الميكروفون',
         icon: 'warning',
         showCancelButton: true,
         confirmButtonText: 'فتح الإعدادات',
         cancelButtonText: 'إلغاء'
     }).then((result) => {
         if (result.isConfirmed) {
             window.open('chrome://settings/content/camera', '_blank');
         }
     });
 }
 
 async function startCall(type) {
     const button = document.querySelector(`.${type}-call`);
     if (!button) return;
     
     try {
         // طلب تفاعل المستخدم أولاً
         await Swal.fire({
             title: 'بدء مكالمة',
             text: type === 'video' ? 'هل تريد بدء مكالمة فيديو؟' : 'هل تريد بدء مكالمة صوتية؟',
             icon: 'question',
             showCancelButton: true,
             confirmButtonText: 'نعم',
             cancelButtonText: 'لا'
         }).then(async (result) => {
             if (result.isConfirmed) {
                 button.classList.add('calling');
                 
                 // التحقق من الأذونات
                 const hasPermissions = await checkAndRequestPermissions(type);
                 if (!hasPermissions) {
                     button.classList.remove('calling');
                     return;
                 }
 
                 // بدء تشغيل صوت الرنين
                 await callAudio.startRingback();
 
                 // إرسال طلب المكالمة
                 const callOffer = {
                     type: `${type}-call-offer`,
                     from: currentUser.uid,
                     to: currentChatUser.uid,
                     timestamp: Date.now()
                 };
 
                 await database.ref(`calls/${currentChatUser.uid}/active`).set(callOffer);
             }
         });
 
     } catch (error) {
         console.error(`خطأ في بدء مكالمة ${type}:`, error);
         button.classList.remove('calling');
         callAudio.stopAll();
         handleCallError(error);
     }
 }
 
 // تحديث دالة showCallInterface
 function showCallInterface(type) {
     const callInterface = document.getElementById('call-interface');
     const callerAvatar = document.getElementById('caller-avatar');
     const callerName = document.getElementById('caller-name');
     const callStatus = document.getElementById('call-status');
     const cameraButton = document.querySelector('.toggle-camera');
     const localVideo = document.getElementById('local-video');
     
     if (!callInterface || !currentChatUser) return;
 
     // تحديث معلومات المتصل
     callerAvatar.src = currentChatUser.avatarUrl || '/api/placeholder/45/45';
     callerName.textContent = currentChatUser.username;
     callStatus.textContent = type === 'video' ? 'جارِ بدء مكالمة فيديو...' : 'جارِ الاتصال...';
     
     // إظهار/إخفاء زر الكاميرا حسب نوع المكالمة
     cameraButton.style.display = type === 'video' ? 'flex' : 'none';
     
     // إظهار واجهة المكالمة
     callInterface.style.display = 'flex';
 
     // إعداد الفيديو المحلي إذا كانت مكالمة فيديو
     if (type === 'video' && localStream && localVideo) {
         localVideo.srcObject = localStream;
         localVideo.play().catch(console.error);
     }
 }
 
 // تحديث دالة startCall
 async function startCall(type) {
     const button = document.querySelector(`.${type}-call`);
     if (!button || !currentChatUser) return;
     
     button.classList.add('calling');
 
     try {
         const hasPermissions = await checkAndRequestPermissions(type);
         if (!hasPermissions) {
             button.classList.remove('calling');
             return;
         }
 
         const mediaConfig = {
             audio: true,
             video: type === 'video'
         };
 
         // الحصول على الوسائط المحلية
         localStream = await navigator.mediaDevices.getUserMedia(mediaConfig);
         
         // إظهار واجهة المكالمة
         showCallInterface(type);
         
         // إعداد اتصال WebRTC
         setupPeerConnection();
 
         // تشغيل صوت الرنين
         await callAudio.startRingback();
 
         // إرسال طلب المكالمة للمستخدم الآخر
         const callOffer = {
             type: `${type}-call-offer`,
             from: currentUser.uid,
             fromName: currentUser.username,
             fromAvatar: currentUser.avatarUrl,
             to: currentChatUser.uid,
             timestamp: Date.now()
         };
 
         await database.ref(`calls/${currentChatUser.uid}/active`).set(callOffer);
 
     } catch (error) {
         console.error(`خطأ في بدء مكالمة ${type}:`, error);
         button.classList.remove('calling');
         callAudio.stopAll();
         handleCallError(error);
     }
 }
 
 // تحديث دالة معالجة المكالمات الواردة
 function setupCallListeners() {
     if (!currentUser) return;
     
     // مراقبة المكالمات الواردة
     database.ref(`calls/${currentUser.uid}/active`).on('value', async (snapshot) => {
         const callData = snapshot.val();
         
         if (callData && callData.to === currentUser.uid) {
             // تشغيل نغمة الرنين
             await callAudio.startRingtone();
             
             // عرض نافذة المكالمة الواردة
             const result = await Swal.fire({
                 title: `${callData.fromName} يتصل بك`,
                 text: callData.type === 'video-call-offer' ? 'مكالمة فيديو واردة' : 'مكالمة صوتية واردة',
                 imageUrl: callData.fromAvatar || '/api/placeholder/45/45',
                 showCancelButton: true,
                 confirmButtonText: 'رد',
                 cancelButtonText: 'رفض',
                 allowOutsideClick: false
             });
 
             callAudio.stopAll();
 
             if (result.isConfirmed) {
                 // قبول المكالمة
                 const type = callData.type.includes('video') ? 'video' : 'voice';
                 await handleAcceptCall(callData, type);
             } else {
                 // رفض المكالمة
                 await handleRejectCall(callData);
             }
         }
     });
 }
 
 // دالة معالجة قبول المكالمة
 async function handleAcceptCall(callData, type) {
     try {
         // إعداد الوسائط المحلية
         const mediaConfig = {
             audio: true,
             video: type === 'video'
         };
         
         localStream = await navigator.mediaDevices.getUserMedia(mediaConfig);
         
         // إظهار واجهة المكالمة
         showCallInterface(type);
         
         // إعداد اتصال WebRTC
         setupPeerConnection();
         
         // إرسال رد القبول
         await database.ref(`calls/${callData.from}/status`).set({
             type: 'answered',
             from: currentUser.uid,
             timestamp: Date.now()
         });
         
     } catch (error) {
         console.error('خطأ في قبول المكالمة:', error);
         handleCallError(error);
     }
 }
 
 // دالة معالجة رفض المكالمة
 async function handleRejectCall(callData) {
     try {
         await database.ref(`calls/${callData.from}/status`).set({
             type: 'rejected',
             from: currentUser.uid,
             timestamp: Date.now()
         });
         
         // مسح المكالمة النشطة
         await database.ref(`calls/${currentUser.uid}/active`).remove();
         
     } catch (error) {
         console.error('خطأ في رفض المكالمة:', error);
     }
 }
 
 // تحديث دالة إنهاء المكالمة
 async function endCall() {
     try {
         callAudio.stopAll();
 
         // إيقاف المسارات المحلية
         if (localStream) {
             localStream.getTracks().forEach(track => track.stop());
             localStream = null;
         }
 
         // إغلاق اتصال WebRTC
         if (peerConnection) {
             peerConnection.close();
             peerConnection = null;
         }
 
         // إخفاء واجهة المكالمة
         const callInterface = document.getElementById('call-interface');
         if (callInterface) {
             callInterface.style.display = 'none';
         }
 
         // إرسال إشعار إنهاء المكالمة
         if (currentChatUser) {
             await database.ref(`calls/${currentChatUser.uid}/status`).set({
                 type: 'ended',
                 from: currentUser.uid,
                 timestamp: Date.now()
             });
             
             // مسح المكالمة النشطة
             await database.ref(`calls/${currentChatUser.uid}/active`).remove();
         }
 
     } catch (error) {
         console.error('خطأ في إنهاء المكالمة:', error);
     }
 }
 
 // تحديث روابط الأصوات للوصول المباشر من GitHub
 const callSounds = {
     ringback: new Audio('https://raw.githubusercontent.com/AlQasimMall/Chat.com/main/sounds/ringback.wav'),
     ringtone: new Audio('https://raw.githubusercontent.com/AlQasimMall/Chat.com/main/sounds/ringback.wav'), 
     callEnd: new Audio('https://raw.githubusercontent.com/AlQasimMall/Chat.com/main/sounds/ringback.wav')
   };
   
   // تحسين دالة تشغيل الأصوات
   const callAudio = {
       async startRingback() {
           try {
               callSounds.ringback.loop = true;
               // تجربة تشغيل الصوت عند النقر
               await callSounds.ringback.play();
           } catch (error) {
               console.warn('Failed to play ringback:', error);
           }
       },
   
       async startRingtone() {
           try {
               callSounds.ringtone.loop = true;
               await callSounds.ringtone.play();
           } catch (error) {
               console.warn('Failed to play ringtone:', error);
           }
       },
   
       stopAll() {
           Object.values(callSounds).forEach(sound => {
               sound.pause();
               sound.currentTime = 0;
           });
       }
   };
 async function handleIncomingCall(callData) {
     const callerSnapshot = await database.ref(`users/${callData.from}`).once('value');
     const callerData = callerSnapshot.val();
     
     if (!callerData) return;
     
     const isVideoCall = callData.type === 'video-call-offer';
     
     // تشغيل نغمة الرنين
     callAudio.startRingtone();
     
     const result = await Swal.fire({
         title: `${callerData.username} يتصل بك`,
         text: isVideoCall ? 'مكالمة فيديو واردة' : 'مكالمة صوتية واردة',
         imageUrl: callerData.avatarUrl || '/api/placeholder/45/45',
         showCancelButton: true,
         confirmButtonText: 'رد',
         cancelButtonText: 'رفض',
         allowOutsideClick: false,
         allowEscapeKey: false
     });
 
     // إيقاف نغمة الرنين
     callAudio.stopAll();
 
     if (result.isConfirmed) {
         // الرد على المكالمة
         await database.ref(`calls/${callData.from}/status`).set({
             type: 'answered',
             from: currentUser.uid,
             timestamp: Date.now()
         });
         
         showCallInterface(isVideoCall ? 'video' : 'voice');
         setupPeerConnection();
         
     } else {
         // رفض المكالمة
         await database.ref(`calls/${callData.from}/status`).set({
             type: 'rejected',
             from: currentUser.uid,
             timestamp: Date.now()
         });
     }
 
     // مسح المكالمة النشطة
     await database.ref(`calls/${currentUser.uid}/active`).remove();
 }
 async function endCall() {
     callAudio.stopAll();
     callSounds.callEnd.play().catch(console.error);
 
     if (localStream) {
         localStream.getTracks().forEach(track => track.stop());
         localStream = null;
     }
 
     if (peerConnection) {
         peerConnection.close();
         peerConnection = null;
     }
 
     const callInterface = document.getElementById('call-interface');
     if (callInterface) {
         callInterface.style.display = 'none';
     }
 
     // مسح بيانات المكالمة
     if (currentChatUser) {
         await database.ref(`calls/${currentChatUser.uid}/active`).remove();
         await database.ref(`calls/${currentChatUser.uid}/status`).set({
             type: 'ended',
             from: currentUser.uid,
             timestamp: Date.now()
         });
     }
 }
 
 // إضافة دالة toggleSpeaker
 function toggleSpeaker() {
     const button = document.querySelector('.toggle-speaker');
     if (button) {
         const isSpeakerOn = button.classList.toggle('active');
         const icon = button.querySelector('i');
         if (icon) {
             icon.classList.toggle('fa-volume-up');
             icon.classList.toggle('fa-volume-mute');
         }
         // تفعيل/تعطيل مكبر الصوت هنا
         if (remoteStream) {
             const audioElement = document.querySelector('audio');
             if (audioElement) {
                 audioElement.setSinkId(isSpeakerOn ? 'default' : 'speaker');
             }
         }
     }
 }
 
 // إضافة دالة toggleMic
 function toggleMic() {
     if (!localStream) return;
     const audioTrack = localStream.getAudioTracks()[0];
     if (audioTrack) {
         audioTrack.enabled = !audioTrack.enabled;
         const button = document.querySelector('.toggle-mic');
         if (button) {
             button.classList.toggle('muted');
             const icon = button.querySelector('i');
             if (icon) {
                 icon.classList.toggle('fa-microphone');
                 icon.classList.toggle('fa-microphone-slash');
             }
         }
     }
 }
 





 // دالة التحقق من الأذونات وطلبها
async function checkAndRequestPermissions(mediaType) {
    try {
        if (!navigator.permissions || !navigator.mediaDevices) {
            throw new Error('المتصفح لا يدعم الوصول إلى الوسائط');
        }

        const permissions = {
            audio: true,
            video: mediaType === 'video'
        };

        // التحقق من أذونات الميكروفون
        const micPermission = await navigator.permissions.query({ name: 'microphone' });
        
        if (permissions.video) {
            // التحقق من أذونات الكاميرا إذا كانت مكالمة فيديو
            const camPermission = await navigator.permissions.query({ name: 'camera' });
            if (micPermission.state === 'denied' || camPermission.state === 'denied') {
                throw new Error('تم رفض الوصول إلى الكاميرا أو الميكروفون');
            }
        } else if (micPermission.state === 'denied') {
            throw new Error('تم رفض الوصول إلى الميكروفون');
        }

        // اختبار الوصول للوسائط
        const stream = await navigator.mediaDevices.getUserMedia(permissions);
        
        // إيقاف المسارات مؤقتاً لاختبار الأذونات فقط
        stream.getTracks().forEach(track => track.stop());
        
        return true;
    } catch (error) {
        handleCallError(error);
        return false;
    }
}

// دالة معالجة أخطاء المكالمات
function handleCallError(error) {
    console.error('خطأ في المكالمة:', error);
    
    let errorMessage = 'حدث خطأ أثناء المكالمة';
    
    // تخصيص رسائل الخطأ
    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
        errorMessage = 'تم رفض الإذن للوصول إلى الميكروفون أو الكاميرا';
    } else if (error.name === 'NotFoundError') {
        errorMessage = 'لم يتم العثور على جهاز الميكروفون أو الكاميرا';
    } else if (error.name === 'NotReadableError') {
        errorMessage = 'لا يمكن الوصول إلى جهاز الميكروفون أو الكاميرا';
    } else if (error.message) {
        errorMessage = error.message;
    }

    // عرض رسالة الخطأ للمستخدم
    Swal.fire({
        icon: 'error',
        title: 'خطأ في المكالمة',
        text: errorMessage,
        confirmButtonText: 'حسناً'
    });

    // إنهاء المكالمة في حالة الخطأ
    endCall();
}

// تحديث دالة بدء المكالمة
async function startCall(type) {
    const button = document.querySelector(`.${type}-call`);
    if (!button || !currentChatUser) return;
    
    try {
        button.classList.add('calling');

        // التحقق من الأذونات أولاً
        const hasPermissions = await checkAndRequestPermissions(type);
        if (!hasPermissions) {
            button.classList.remove('calling');
            return;
        }

        // تكوين إعدادات الوسائط
        const mediaConstraints = {
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            },
            video: type === 'video'
        };

        // الحصول على الوسائط المحلية
        localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
        
        // إظهار واجهة المكالمة
        showCallInterface(type);
        
        // إعداد اتصال WebRTC
        setupPeerConnection();

        // تشغيل صوت الرنين
        await callAudio.startRingback();

        // إرسال طلب المكالمة للمستخدم الآخر
        const callOffer = {
            type: `${type}-call-offer`,
            from: currentUser.uid,
            fromName: currentUser.username,
            fromAvatar: currentUser.avatarUrl,
            to: currentChatUser.uid,
            timestamp: Date.now()
        };

        await database.ref(`calls/${currentChatUser.uid}/active`).set(callOffer);

    } catch (error) {
        handleCallError(error);
    }
}

// دالة تحديث حالة المكالمة
function updateCallStatus(status, duration = null) {
    const statusElement = document.getElementById('call-status');
    const timerElement = document.getElementById('call-timer');
    
    if (statusElement) {
        switch (status) {
            case 'calling':
                statusElement.textContent = 'جاري الاتصال...';
                break;
            case 'connected':
                statusElement.textContent = 'تم الاتصال';
                break;
            case 'ended':
                statusElement.textContent = 'تم إنهاء المكالمة';
                if (duration && timerElement) {
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    timerElement.textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                break;
            case 'rejected':
                statusElement.textContent = 'تم رفض المكالمة';
                break;
            case 'missed':
                statusElement.textContent = 'مكالمة فائتة';
                break;
            default:
                statusElement.textContent = status;
        }
    }
}



// دالة التحقق من وجود العناصر
function getCallElements() {
    const elements = {
        interface: document.getElementById('call-interface'),
        callerAvatar: document.getElementById('caller-avatar'),
        callerName: document.getElementById('caller-name'),
        callStatus: document.getElementById('call-status'),
        callTimer: document.getElementById('call-timer'),
        remoteAudio: document.getElementById('remote-audio'),
        localVideo: document.getElementById('local-video'),
        remoteVideo: document.getElementById('remote-video')
    };

    // التحقق من وجود العناصر الأساسية
    const missingElements = Object.entries(elements)
        .filter(([key, element]) => !element && ['interface', 'callerAvatar', 'callerName', 'callStatus'].includes(key))
        .map(([key]) => key);

    if (missingElements.length > 0) {
        console.error('العناصر المفقودة:', missingElements);
        return null;
    }

    return elements;
}

// تحديث دالة عرض واجهة الاتصال
function showCallInterface(type) {
    const elements = getCallElements();
    if (!elements) {
        handleCallError(new Error('لم يتم العثور على عناصر واجهة الاتصال'));
        return;
    }

    try {
        // تحديث حالة المكالمة
        elements.interface.style.display = 'flex';
        
        // تحديث معلومات المتصل
        if (currentChatUser) {
            elements.callerAvatar.src = currentChatUser.avatarUrl || '/api/placeholder/45/45';
            elements.callerName.textContent = currentChatUser.username;
            elements.callStatus.textContent = 'جاري الاتصال...';
        }

        // إعداد عناصر الفيديو إذا كانت مكالمة فيديو
        if (type === 'video' && elements.localVideo && localStream) {
            elements.localVideo.style.display = 'block';
            elements.localVideo.srcObject = localStream;
            elements.localVideo.play().catch(console.error);
        } else if (elements.localVideo) {
            elements.localVideo.style.display = 'none';
        }

        // إظهار/إخفاء أزرار التحكم حسب نوع المكالمة
        const cameraButton = document.querySelector('.toggle-camera');
        if (cameraButton) {
            cameraButton.style.display = type === 'video' ? 'flex' : 'none';
        }

    } catch (error) {
        console.error('خطأ في عرض واجهة الاتصال:', error);
        handleCallError(error);
    }
}

// تحديث دالة بدء المكالمة
async function startCall(type) {
    const elements = getCallElements();
    if (!elements) {
        Swal.fire({
            icon: 'error',
            title: 'خطأ في المكالمة',
            text: 'لم يتم العثور على عناصر واجهة الاتصال'
        });
        return;
    }

    const button = document.querySelector(`.${type}-call`);
    if (!button || !currentChatUser) return;
    
    try {
        button.classList.add('calling');

        // التحقق من الأذونات
        const hasPermissions = await checkAndRequestPermissions(type);
        if (!hasPermissions) {
            button.classList.remove('calling');
            return;
        }

        // تكوين إعدادات الوسائط
        const mediaConstraints = {
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            },
            video: type === 'video'
        };

        // الحصول على الوسائط المحلية
        localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
        
        // إظهار واجهة المكالمة
        showCallInterface(type);
        
        // إعداد اتصال WebRTC
        setupPeerConnection();

        // تشغيل صوت الرنين
        await callAudio.startRingback();

        // إرسال طلب المكالمة
        const callOffer = {
            type: `${type}-call-offer`,
            from: currentUser.uid,
            fromName: currentUser.username,
            fromAvatar: currentUser.avatarUrl,
            to: currentChatUser.uid,
            timestamp: Date.now()
        };

        await database.ref(`calls/${currentChatUser.uid}/active`).set(callOffer);

    } catch (error) {
        button.classList.remove('calling');
        handleCallError(error);
    }
}

// تحديث دالة إنهاء المكالمة
async function endCall() {
    const elements = getCallElements();
    
    try {
        // إيقاف عداد المكالمة
        if (callTimer) {
            clearInterval(callTimer);
            callTimer = null;
        }

        // إيقاف الأصوات
        callAudio.stopAll();
        callSounds.callEnd.play().catch(console.error);

        // إيقاف المسارات المحلية
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }

        // إغلاق اتصال WebRTC
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }

        // إخفاء واجهة المكالمة
        if (elements?.interface) {
            elements.interface.style.display = 'none';
            if (elements.callStatus) {
                elements.callStatus.textContent = 'تم إنهاء المكالمة';
            }
        }

        // إرسال إشعار إنهاء المكالمة
        if (currentChatUser) {
            await database.ref(`calls/${currentChatUser.uid}/status`).set({
                type: 'ended',
                from: currentUser.uid,
                timestamp: Date.now(),
                duration: callDuration
            });
            
            await database.ref(`calls/${currentChatUser.uid}/active`).remove();
        }

    } catch (error) {
        console.error('خطأ في إنهاء المكالمة:', error);
    }
}

if ('serviceWorker' in navigator && 'Notification' in window) {
    window.addEventListener('load', async () => {
        try {
            const registration = await navigator.serviceWorker.register('/service-worker.js');
            console.log('ServiceWorker registered');

            // طلب إذن الإشعارات
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                // تفعيل الإشعارات في Firebase
                const messaging = firebase.messaging();
                const currentToken = await messaging.getToken();
                
                if (currentToken) {
                    // تحديث التوكن في قاعدة البيانات
                    if (currentUser) {
                        await database.ref(`users/${currentUser.uid}/notificationToken`).set(currentToken);
                    }
                }
            }

            // إعداد مستمع للمكالمات في الخلفية
            if (registration.active) {
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'ANSWER_CALL') {
                        handleIncomingCall(event.data.callData);
                    } else if (event.data.type === 'END_CALL') {
                        endCall();
                    }
                });
            }
        } catch (error) {
            console.error('ServiceWorker registration failed:', error);
        }
    });
}

// تحديث دالة startCall لدعم المكالمات في الخلفية
async function startCall(type) {
    try {
        const button = document.querySelector(`.${type}-call`);
        if (!button || !currentChatUser) return;
        
        button.classList.add('calling');

        // التحقق من الأذونات
        const hasPermissions = await checkAndRequestPermissions(type);
        if (!hasPermissions) {
            button.classList.remove('calling');
            return;
        }

        // إخطار Service Worker ببدء المكالمة
        if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
                type: 'CALL_STATUS',
                isActive: true,
                callerName: currentUser.username,
                callerAvatar: currentUser.avatarUrl,
                callType: type
            });
        }

        // بقية منطق المكالمة...
        const mediaConfig = {
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            },
            video: type === 'video'
        };

        localStream = await navigator.mediaDevices.getUserMedia(mediaConfig);
        showCallInterface(type);
        setupPeerConnection();
        await callAudio.startRingback();

        // إرسال طلب المكالمة للمستخدم الآخر
        await database.ref(`calls/${currentChatUser.uid}/active`).set({
            type: `${type}-call-offer`,
            from: currentUser.uid,
            fromName: currentUser.username,
            fromAvatar: currentUser.avatarUrl,
            to: currentChatUser.uid,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

    } catch (error) {
        console.error('Error starting call:', error);
        button?.classList.remove('calling');
        handleCallError(error);
    }
}

// تحديث دالة إنهاء المكالمة
async function endCall() {
    try {
        // إخطار Service Worker بإنهاء المكالمة
        if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
                type: 'CALL_STATUS',
                isActive: false
            });
        }

        // إيقاف الأصوات والمسارات
        callAudio.stopAll();
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }

        // إغلاق اتصال WebRTC
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }

        // تحديث واجهة المستخدم
        const callInterface = document.getElementById('call-interface');
        if (callInterface) {
            callInterface.style.display = 'none';
        }

        // تحديث حالة المكالمة في Firebase
        if (currentChatUser) {
            await database.ref(`calls/${currentChatUser.uid}/status`).set({
                type: 'ended',
                from: currentUser.uid,
                timestamp: Date.now()
            });
            
            await database.ref(`calls/${currentChatUser.uid}/active`).remove();
        }

    } catch (error) {
        console.error('Error ending call:', error);
    }
}

// دالة لتفعيل مزامنة الرسائل في الخلفية
async function enableBackgroundSync() {
    if ('serviceWorker' in navigator && 'SyncManager' in window) {
        try {
            const registration = await navigator.serviceWorker.ready;
            // تسجيل مزامنة الرسائل
            await registration.sync.register('send-messages');
            // تسجيل مزامنة المكالمات
            await registration.sync.register('sync-calls');
        } catch (error) {
            console.error('Background sync registration failed:', error);
        }
    }
}

// تحديث دالة إرسال الرسائل لدعم المزامنة في الخلفية
async function sendMessage(event) {
    event.preventDefault();
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    const selectedFiles = Array.from(document.querySelectorAll('.selected-file-preview'));
    
    if (!message && selectedFiles.length === 0) return;
    
    try {
        const messageData = {
            senderId: currentUser.uid,
            senderName: currentUser.username,
            message: message,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            status: navigator.onLine ? 'sent' : 'pending',
            attachments: []
        };

        // حفظ الرسالة محلياً إذا كان الاتصال غير متوفر
        if (!navigator.onLine) {
            await saveMessageLocally(messageData);
            enableBackgroundSync();
        } else {
            // إرسال الرسالة مباشرة
            const chatId = getChatId(currentUser.uid, currentChatUser.uid);
            await database.ref(`chats/${chatId}/messages`).push(messageData);
        }

        // تنظيف الحقول
        messageInput.value = '';
        selectedFiles.forEach(preview => preview.remove());

    } catch (error) {
        console.error('Error sending message:', error);
        Swal.fire({
            icon: 'error',
            title: 'خطأ في الإرسال',
            text: error.message
        });
    }
}
 
 </script>
 </body>
 </html>
 
